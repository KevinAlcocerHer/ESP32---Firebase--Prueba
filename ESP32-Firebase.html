<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Monitor de Temperatura y Humedad</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-database-compat.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      padding: 20px;
    }
    h1 {
      color: #333;
      text-align: center;
      margin-bottom: 30px;
    }
    .current-readings {
      display: flex;
      justify-content: space-around;
      margin-bottom: 40px;
    }
    .reading-card {
      background-color: #f8f9fa;
      border-radius: 10px;
      padding: 20px;
      width: 40%;
      text-align: center;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }
    .reading-card h2 {
      margin-top: 0;
      color: #555;
      font-size: 18px;
    }
    .reading-value {
      font-size: 48px;
      font-weight: bold;
      margin: 10px 0;
    }
    .temperature {
      color: #dc3545;
    }
    .humidity {
      color: #0d6efd;
    }
    .chart-container {
      position: relative;
      height: 400px;
      width: 100%;
    }
    .footer {
      text-align: center;
      margin-top: 30px;
      color: #6c757d;
      font-size: 14px;
    }
    .last-update {
      text-align: right;
      font-size: 12px;
      color: #6c757d;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Monitor de Temperatura y Humedad</h1>
    
    <div class="current-readings">
      <div class="reading-card">
        <h2>Temperatura</h2>
        <div class="reading-value temperature" id="temp-value">--</div>
        <div>°C</div>
      </div>
      
      <div class="reading-card">
        <h2>Humedad</h2>
        <div class="reading-value humidity" id="humidity-value">--</div>
        <div>%</div>
      </div>
    </div>
    
    <div class="chart-container">
      <canvas id="sensorChart"></canvas>
    </div>
    
    <div class="last-update" id="last-update">Última actualización: --</div>
    
    <div class="footer">
      <p>ESP32 + Firebase + Sensor DHT</p>
    </div>
  </div>

  <script>
    // Configuración de Firebase
    const firebaseConfig = {
      // IMPORTANTE: Debes reemplazar esto con tu configuración de Firebase
    apiKey: "AIzaSyA6L6vcWsQcaucQTjmz7svKrCo1t0L-M6c",
    authDomain: "esp32-93fbb.firebaseapp.com",
    databaseURL: "https://esp32-93fbb-default-rtdb.firebaseio.com",
    projectId: "esp32-93fbb",
    storageBucket: "esp32-93fbb.firebasestorage.app",
    messagingSenderId: "623403559263",
    appId: "1:623403559263:web:afdd3dca5dddf9d6346eea",
    measurementId: "G-XWZK0QF50D"
    };
    
    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    
    // Referencia a los datos del sensor (ajusta la ruta según tu estructura en Firebase)
    const sensorRef = database.ref('sensor');
    
    // Elementos del DOM
    const tempValue = document.getElementById('temp-value');
    const humidityValue = document.getElementById('humidity-value');
    const lastUpdate = document.getElementById('last-update');
    
    // Datos para el gráfico
    const chartData = {
    labels: [],
    datasets: [
        {
        label: 'Temperatura (°C)',
        data: [],
        borderColor: '#dc3545',
        backgroundColor: 'rgba(220, 53, 69, 0.1)',
        yAxisID: 'y',
        tension: 0.3,
        pointRadius: 3
        },
        {
        label: 'Humedad (%)',
        data: [],
        borderColor: '#0d6efd',
        backgroundColor: 'rgba(13, 110, 253, 0.1)',
        yAxisID: 'y1',
        tension: 0.3,
        pointRadius: 3
        }
    ]
    };
    
    // Configuración del gráfico
    const chartConfig = {
    type: 'line',
    data: chartData,
    options: {
        responsive: true,
        interaction: {
        mode: 'index',
        intersect: false,
        },
        stacked: false,
        scales: {
          x: {
            title: {
              display: true,
              text: 'Tiempo'
            }
          },
          y: {
            type: 'linear',
            display: true,
            position: 'left',
            title: {
              display: true,
              text: 'Temperatura (°C)'
            },
            min: 0,
            max: 50,
            ticks: {
              stepSize: 5
            }
          },
          y1: {
            type: 'linear',
            display: true,
            position: 'right',
            title: {
              display: true,
              text: 'Humedad (%)'
            },
            min: 0,
            max: 100,
            grid: {
              drawOnChartArea: false,
            },
            ticks: {
              stepSize: 10
            }
          },
        }
      },
    };
    
    // Crear el gráfico
    const ctx = document.getElementById('sensorChart').getContext('2d');
    const sensorChart = new Chart(ctx, chartConfig);
    
    // Función para actualizar el gráfico con nuevos datos
    function updateChart(timestamp, temp, humidity) {
      // Convertir timestamp a hora legible
      const date = new Date(timestamp);
      const timeStr = date.getHours().toString().padStart(2, '0') + ':' + 
                      date.getMinutes().toString().padStart(2, '0') + ':' + 
                      date.getSeconds().toString().padStart(2, '0');
      
      // Añadir nuevos datos (limitamos a 30 puntos de datos para mejor visualización)
      if (chartData.labels.length > 30) {
        chartData.labels.shift();
        chartData.datasets[0].data.shift();
        chartData.datasets[1].data.shift();
      }
      
      chartData.labels.push(timeStr);
      chartData.datasets[0].data.push(temp);
      chartData.datasets[1].data.push(humidity);
      
      // Actualizar el gráfico
      sensorChart.update();
    }
    
    // Escuchar cambios en tiempo real desde Firebase
    sensorRef.on('value', (snapshot) => {
    const data = snapshot.val();
    
  // Actualizar valores actuales
    if (data) {
    tempValue.textContent = data.temperature.toFixed(1);
    humidityValue.textContent = data.humidity.toFixed(1);
    
    // Formatear la fecha
    const date = new Date();
    lastUpdate.textContent = `Última actualización: ${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
    
    // Actualizar gráfico
    updateChart(Date.now(), data.temperature, data.humidity);
    }
});
    
    // Cargar datos históricos al iniciar
    sensorRef.limitToLast(30).once('value', (snapshot) => {
      const dataPoints = [];
      
      snapshot.forEach((childSnapshot) => {
        const data = childSnapshot.val();
        if (data && data.temperatura && data.humedad) {
          dataPoints.push({
            timestamp: data.timestamp || Date.now(),
            temperatura: data.temperatura,
            humedad: data.humedad
          });
        }
      });
      
      // Ordenar por timestamp
      dataPoints.sort((a, b) => a.timestamp - b.timestamp);
      
      // Limpiar datos existentes
      chartData.labels = [];
      chartData.datasets[0].data = [];
      chartData.datasets[1].data = [];
      
      // Añadir todos los puntos de datos
      dataPoints.forEach(point => {
        const date = new Date(point.timestamp);
        const timeStr = date.getHours().toString().padStart(2, '0') + ':' + 
                        date.getMinutes().toString().padStart(2, '0') + ':' + 
                        date.getSeconds().toString().padStart(2, '0');
        
        chartData.labels.push(timeStr);
        chartData.datasets[0].data.push(point.temperatura);
        chartData.datasets[1].data.push(point.humedad);
      });
      
      // Actualizar el gráfico
      sensorChart.update();
      
      // Actualizar el último valor si hay datos
      if (dataPoints.length > 0) {
        const lastPoint = dataPoints[dataPoints.length - 1];
        tempValue.textContent = lastPoint.temperatura.toFixed(1);
        humidityValue.textContent = lastPoint.humedad.toFixed(1);
        
        const date = new Date(lastPoint.timestamp);
        lastUpdate.textContent = `Última actualización: ${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
      }
    });
  </script>
</body>
</html>