<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Monitor de Temperatura y Humedad</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-database-compat.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      transition: all 0.5s ease;
    }
    
    :root {
      --background-light: linear-gradient(135deg, #6a85b6 0%, #bac8e0 100%);
      --background-dark: linear-gradient(135deg, #2c3e50 0%, #1a1a2e 100%);
      --text-light: #333;
      --text-dark: #f0f0f0;
      --card-bg-light: rgba(255, 255, 255, 0.92);
      --card-bg-dark: rgba(37, 37, 50, 0.92);
      --reading-card-light: rgba(248, 249, 250, 0.8);
      --reading-card-dark: rgba(30, 30, 42, 0.8);
      --border-light: rgba(0, 0, 0, 0.05);
      --border-dark: rgba(255, 255, 255, 0.05);
      --shadow-light: rgba(0, 0, 0, 0.15);
      --shadow-dark: rgba(0, 0, 0, 0.25);
      --footer-text-light: #6c757d;
      --footer-text-dark: #a0a0a0;
      --border-top-light: rgba(238, 238, 238, 0.7);
      --border-top-dark: rgba(70, 70, 90, 0.7);
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      margin: 0;
      padding: 0;
      background: var(--background-light);
      color: var(--text-light);
      line-height: 1.6;
      min-height: 100vh;
      transition: background 1.5s ease, color 0.5s ease;
    }
    
    body.dark-mode {
      background: var(--background-dark);
      color: var(--text-dark);
    }
    
    /* Estilos para diferentes temperaturas - Modo Claro */
    body.temp-cold {
      background: linear-gradient(135deg, #5b86e5 0%, #36d1dc 100%);
    }
    
    body.temp-cool {
      background: linear-gradient(135deg, #36d1dc 0%, #5b86e5 100%);
    }
    
    body.temp-mild {
      background: linear-gradient(135deg, #7bc6cc 0%, #be93c5 100%);
    }
    
    body.temp-warm {
      background: linear-gradient(135deg, #ffd89b 0%, #ff9d6c 100%);
    }
    
    body.temp-hot {
      background: linear-gradient(135deg, #ff9a9e 0%, #ff7966 100%);
    }
    
    body.temp-very-hot {
      background: linear-gradient(135deg, #ff7966 0%, #ff4b2b 100%);
    }
    
    /* Estilos para diferentes temperaturas - Modo Oscuro */
    body.dark-mode.temp-cold {
      background: linear-gradient(135deg, #1a2a40 0%, #253b47 100%);
    }
    
    body.dark-mode.temp-cool {
      background: linear-gradient(135deg, #253b47 0%, #1a2a40 100%);
    }
    
    body.dark-mode.temp-mild {
      background: linear-gradient(135deg, #2c3e50 0%, #3a2842 100%);
    }
    
    body.dark-mode.temp-warm {
      background: linear-gradient(135deg, #4a3636 0%, #543326 100%);
    }
    
    body.dark-mode.temp-hot {
      background: linear-gradient(135deg, #582f33 0%, #612926 100%);
    }
    
    body.dark-mode.temp-very-hot {
      background: linear-gradient(135deg, #612926 0%, #6a1b16 100%);
    }
    
    .container {
      width: 95%;
      max-width: 1200px;
      margin: 15px auto;
      background-color: var(--card-bg-light);
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
      padding: 20px;
      overflow: hidden;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      transition: background-color 0.5s ease, box-shadow 0.5s ease;
      animation: fadeIn 0.8s ease-out;
    }
    
    .dark-mode .container {
      background-color: var(--card-bg-dark);
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
    }
    
    h1 {
      color: var(--text-light);
      text-align: center;
      margin-bottom: 20px;
      font-size: 1.8rem;
      transition: color 0.5s ease;
      animation: slideDown 0.6s ease-out;
    }
    
    .dark-mode h1 {
      color: var(--text-dark);
    }
    
    @media (max-width: 600px) {
      h1 {
        font-size: 1.5rem;
      }
    }
    
    .current-readings {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-around;
      gap: 20px;
      margin-bottom: 30px;
      animation: fadeInUp 0.8s ease-out;
    }
    
    .reading-card {
      background-color: var(--reading-card-light);
      border-radius: 10px;
      padding: 20px;
      min-width: 150px;
      flex: 1;
      text-align: center;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease, background-color 0.5s ease;
      border: 1px solid var(--border-light);
      animation: pulse 2s infinite;
    }
    
    .dark-mode .reading-card {
      background-color: var(--reading-card-dark);
      border: 1px solid var(--border-dark);
      box-shadow: 0 4px 15px var(--shadow-dark);
    }
    
    .reading-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px var(--shadow-light);
    }
    
    .dark-mode .reading-card:hover {
      box-shadow: 0 8px 25px var(--shadow-dark);
    }
    
    .reading-card h2 {
      margin-top: 0;
      color: #555;
      font-size: 1.2rem;
      transition: color 0.5s ease;
    }
    
    .dark-mode .reading-card h2 {
      color: #bbb;
    }
    
    .reading-value {
      font-size: 2.5rem;
      font-weight: bold;
      margin: 10px 0;
      transition: color 0.3s ease;
    }
    
    @media (max-width: 600px) {
      .reading-value {
        font-size: 2rem;
      }
    }
    
    .temperature {
      color: #dc3545;
    }
    
    .humidity {
      color: #0d6efd;
    }
    
    .temp-icon {
      font-size: 1.8rem;
      margin: 5px 0;
      animation: bounce 2s infinite;
    }
    
    .chart-container {
      position: relative;
      height: 50vh;
      min-height: 300px;
      width: 100%;
      margin: 20px 0;
      background-color: rgba(255, 255, 255, 0.7);
      padding: 10px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      transition: background-color 0.5s ease, box-shadow 0.5s ease;
      animation: fadeIn 1s ease-out;
    }
    
    .dark-mode .chart-container {
      background-color: rgba(30, 30, 42, 0.7);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .footer {
      text-align: center;
      margin-top: 20px;
      color: var(--footer-text-light);
      font-size: 0.9rem;
      padding: 10px 0;
      border-top: 1px solid var(--border-top-light);
      transition: color 0.5s ease, border-top 0.5s ease;
    }
    
    .dark-mode .footer {
      color: var(--footer-text-dark);
      border-top: 1px solid var(--border-top-dark);
    }
    
    .last-update {
      text-align: right;
      font-size: 0.8rem;
      color: var(--footer-text-light);
      margin-top: 10px;
      transition: color 0.5s ease;
    }
    
    .dark-mode .last-update {
      color: var(--footer-text-dark);
    }
    
    /* Estado de carga */
    .loading {
      text-align: center;
      padding: 30px;
      color: var(--footer-text-light);
      transition: color 0.5s ease;
      animation: pulse 1.5s infinite;
    }
    
    .dark-mode .loading {
      color: var(--footer-text-dark);
    }
    
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border-left-color: #0d6efd;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    
    .dark-mode .spinner {
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-left-color: #0d6efd;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @keyframes fadeIn {
      0% { opacity: 0; }
      100% { opacity: 1; }
    }
    
    @keyframes fadeInUp {
      0% { opacity: 0; transform: translateY(20px); }
      100% { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.02); }
      100% { transform: scale(1); }
    }
    
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }
    
    @keyframes slideDown {
      0% { transform: translateY(-20px); opacity: 0; }
      100% { transform: translateY(0); opacity: 1; }
    }
    
    .status-indicator {
      display: inline-block;
      font-size: 0.9rem;
      padding: 8px 15px;
      border-radius: 30px;
      margin: 15px auto;
      text-align: center;
      display: block;
      max-width: 150px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      animation: pulse 2s infinite;
    }
    
    .status-ok {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .dark-mode .status-ok {
      background-color: #1e3a2d;
      color: #8fcea8;
      border: 1px solid #2c573c;
    }
    
    .status-warning {
      background-color: #fff3cd;
      color: #856404;
      border: 1px solid #ffeeba;
    }
    
    .dark-mode .status-warning {
      background-color: #3a3120;
      color: #e0c77c;
      border: 1px solid #574b27;
    }
    
    .status-error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .dark-mode .status-error {
      background-color: #3b1c1f;
      color: #dca0a6;
      border: 1px solid #57262b;
    }
    
    /* Dise√±o de orientaci√≥n */
    @media (orientation: landscape) and (max-height: 500px) {
      .container {
        padding: 10px;
      }
      
      .current-readings {
        margin-bottom: 15px;
      }
      
      .chart-container {
        height: 40vh;
        min-height: 200px;
      }
    }
    
    /* Estilo para mensajes de error */
    .error-message {
      background-color: #f8d7da;
      color: #721c24;
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
      text-align: center;
      display: none;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      border: 1px solid #f5c6cb;
      transition: all 0.5s ease;
      animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
    }
    
    .dark-mode .error-message {
      background-color: #3b1c1f;
      color: #dca0a6;
      border: 1px solid #57262b;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }
    
    @keyframes shake {
      10%, 90% { transform: translate3d(-1px, 0, 0); }
      20%, 80% { transform: translate3d(2px, 0, 0); }
      30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
      40%, 60% { transform: translate3d(4px, 0, 0); }
    }
    
    /* Temperatura descriptor */
    .temp-descriptor {
      display: block;
      text-align: center;
      margin: 10px auto 20px;
      font-size: 1.2rem;
      padding: 10px 20px;
      border-radius: 30px;
      color: white;
      font-weight: bold;
      max-width: 250px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      transition: all 0.5s ease;
      animation: fadeInUp 0.8s ease-out;
    }
    
    .temp-cold-text {
      background: linear-gradient(to right, #5b86e5, #36d1dc);
    }
    
    .dark-mode .temp-cold-text {
      background: linear-gradient(to right, #3a5c99, #257a80);
    }
    
    .temp-mild-text {
      background: linear-gradient(to right, #7bc6cc, #be93c5);
    }
    
    .dark-mode .temp-mild-text {
      background: linear-gradient(to right, #4a7a7d, #795c7e);
    }
    
    .temp-warm-text {
      background: linear-gradient(to right, #ffd89b, #ff9a9e);
    }
    
    .dark-mode .temp-warm-text {
      background: linear-gradient(to right, #a6896a, #a66669);
    }
    
    .temp-hot-text {
      background: linear-gradient(to right, #ff9a9e, #ff4b2b);
    }
    
    /* Bot√≥n para reiniciar/actualizar gr√°fica */
    .chart-controls {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 10px;
    }
    
    .refresh-btn {
      background-color: #0d6efd;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
      transition: all 0.3s ease;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    
    .refresh-btn:hover {
      background-color: #0b5ed7;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }
    
    .refresh-btn:active {
      transform: translateY(0);
    }
    
    .dark-mode .refresh-btn {
      background-color: #2d63b7;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }
    
    .dark-mode .refresh-btn:hover {
      background-color: #3a71c9;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }
    
    .refresh-icon {
      display: inline-block;
      transition: transform 0.5s ease;
    }
    
    .min-max-readings {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-around;
      gap: 15px;
      margin: 20px 0;
      animation: fadeInUp 0.8s ease-out;
    }
    
    .min-max-card {
      background-color: var(--reading-card-light);
      border-radius: 10px;
      padding: 15px;
      min-width: 120px;
      flex: 1;
      text-align: center;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
      transition: transform 0.3s ease, box-shadow 0.3s ease, background-color 0.5s ease;
      border: 1px solid var(--border-light);
    }
    
    .dark-mode .min-max-card {
      background-color: var(--reading-card-dark);
      border: 1px solid var(--border-dark);
      box-shadow: 0 3px 10px var(--shadow-dark);
    }
    
    .min-max-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    
    .dark-mode .min-max-card:hover {
      box-shadow: 0 5px 15px var(--shadow-dark);
    }
    
    .min-max-card h3 {
      margin-top: 0;
      color: #666;
      font-size: 1rem;
      margin-bottom: 8px;
      transition: color 0.5s ease;
    }
    
    .dark-mode .min-max-card h3 {
      color: #bbb;
    }
    
    .min-value {
      font-size: 1.6rem;
      font-weight: bold;
      margin: 5px 0;
      transition: color 0.3s ease;
      color: #0d6efd;
    }
    
    .max-value {
      font-size: 1.6rem;
      font-weight: bold;
      margin: 5px 0;
      transition: color 0.3s ease;
      color: #dc3545;
    }
    
    .reset-min-max {
      background-color: #6c757d;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 5px 10px;
      font-size: 0.8rem;
      cursor: pointer;
      margin-top: 10px;
      transition: background-color 0.3s ease;
    }
    
    .reset-min-max:hover {
      background-color: #5a6268;
    }
    
    .dark-mode .reset-min-max {
      background-color: #495057;
    }
    
    .dark-mode .reset-min-max:hover {
      background-color: #343a40;
    }
    .theme-switch-wrapper {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      margin-bottom: 10px;
    }
    
    .theme-switch {
      display: inline-block;
      height: 26px;
      position: relative;
      width: 50px;
    }
    
    .theme-switch input {
      display: none;
    }
    
    .slider {
      background-color: #ccc;
      bottom: 0;
      cursor: pointer;
      left: 0;
      position: absolute;
      right: 0;
      top: 0;
      transition: .4s;
      border-radius: 34px;
    }
    
    .slider:before {
      background-color: #fff;
      bottom: 4px;
      content: "";
      height: 18px;
      left: 4px;
      position: absolute;
      transition: .4s;
      width: 18px;
      border-radius: 50%;
    }
    
    input:checked + .slider {
      background-color: #2196F3;
    }
    
    input:checked + .slider:before {
      transform: translateX(24px);
    }
    
    .theme-switch-wrapper em {
      margin-right: 10px;
      font-size: 0.9rem;
      color: var(--text-light);
      transition: color 0.5s ease;
    }
    
    .dark-mode .theme-switch-wrapper em {
      color: var(--text-dark);
    }
    
    /* Estado de conexi√≥n Firebase */
    .connection-status {
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 15px auto;
      font-size: 0.9rem;
      animation: fadeIn 1s ease-out;
    }
    
    .connection-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
      transition: all 0.5s ease;
    }
    
    .connection-online {
      background-color: #28a745;
      box-shadow: 0 0 8px #28a745;
      animation: pulse 2s infinite;
    }
    
    .connection-offline {
      background-color: #dc3545;
      box-shadow: 0 0 8px #dc3545;
      animation: pulse 2s infinite;
    }
    
    .connection-waiting {
      background-color: #ffc107;
      box-shadow: 0 0 8px #ffc107;
      animation: pulse 2s infinite;
    }
    
    .connection-text {
      color: var(--footer-text-light);
      transition: color 0.5s ease;
    }
    
    .dark-mode .connection-text {
      color: var(--footer-text-dark);
    }

    /* ESTILOS PARA CONFIGURACI√ìN DE TELEGRAM */
.telegram-config-section {
  background-color: var(--reading-card-light);
  border-radius: 10px;
  padding: 20px;
  margin: 30px 0;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  border: 1px solid var(--border-light);
  animation: fadeInUp 0.8s ease-out;
}

.dark-mode .telegram-config-section {
  background-color: var(--reading-card-dark);
  border: 1px solid var(--border-dark);
}

.config-form {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
}

@media (max-width: 768px) {
  .config-form {
    grid-template-columns: 1fr;
  }
}

.form-group {
  margin-bottom: 15px;
}

.form-group label {
  display: block;
  margin-bottom: 5px;
  font-weight: 500;
}

.form-control {
  width: 100%;
  padding: 10px;
  border-radius: 5px;
  border: 1px solid #ced4da;
  font-size: 1rem;
}

.form-switch {
  display: flex;
  align-items: center;
  cursor: pointer;
}

.form-switch input {
  margin-right: 10px;
  width: 40px;
  height: 20px;
  appearance: none;
  background-color: #ccc;
  border-radius: 20px;
  position: relative;
  cursor: pointer;
}

.form-switch input:checked {
  background-color: #0d6efd;
}

.form-switch input:before {
  content: '';
  position: absolute;
  width: 16px;
  height: 16px;
  border-radius: 50%;
  background-color: white;
  top: 2px;
  left: 2px;
  transition: transform 0.3s;
}

.form-switch input:checked:before {
  transform: translateX(20px);
}

.btn {
  padding: 10px 15px;
  border-radius: 5px;
  border: none;
  font-size: 1rem;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  margin-right: 10px;
}

.btn-primary {
  background-color: #0d6efd;
  color: white;
}

.btn-primary:hover {
  background-color: #0b5ed7;
}

.btn-test {
  background-color: #28a745;
  color: white;
}

.btn-test:hover {
  background-color: #218838;
}

.recipient-info {
  margin-top: 20px;
  padding: 15px;
  border-radius: 8px;
  background-color: rgba(240, 240, 240, 0.5);
  border: 1px solid #dee2e6;
}

.alert-item {
  padding: 10px;
  border-bottom: 1px solid #dee2e6;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.alert-item:last-child {
  border-bottom: none;
}

.alert-item-time {
  font-size: 0.8rem;
  color: #777;
}

.alert-item-temp {
  font-weight: 600;
  color: #dc3545;
}

.input-group {
  display: flex;
  width: 100%;
}

.form-select {
  padding: 10px;
  border-radius: 0 5px 5px 0;
  border: 1px solid #ced4da;
  border-left: none;
  background-color: white;
  font-size: 1rem;
  min-width: 100px;
}

.dark-mode .form-select {
  background-color: #2a2a3a;
  border-color: #444;
  color: #eee;
}

.input-group .form-control {
  border-radius: 5px 0 0 5px;
}

  </style>
</head>
<body class="temp-mild">
  <div class="container">
    <div class="theme-switch-wrapper">
      <em>Modo</em>
      <label class="theme-switch" for="checkbox">
        <input type="checkbox" id="checkbox" />
        <span class="slider"></span>
      </label>
    </div>

    <h1>Monitor de Temperatura y Humedad</h1>
    
    <div id="error-message" class="error-message">
      Error al conectar con la base de datos. Por favor, verifica tu conexi√≥n.
    </div>
    
    <div id="loading" class="loading">
      <div class="spinner"></div>
      <p>Cargando datos...</p>
    </div>
    
    <div id="dashboard-content" style="display: none;">
      <div id="temp-descriptor" class="temp-descriptor temp-mild-text">Temperatura normal</div>
      
      <div class="connection-status">
        <div id="connection-indicator" class="connection-indicator connection-waiting"></div>
        <span id="connection-text" class="connection-text">Verificando conexi√≥n...</span>
      </div>
      
      <div class="current-readings">
        <div class="reading-card">
          <h2>Temperatura</h2>
          <div id="temp-icon" class="temp-icon">üå°Ô∏è</div>
          <div class="reading-value temperature" id="temp-value">--</div>
          <div>¬∞C</div>
        </div>
        
        <div class="reading-card">
          <h2>Humedad</h2>
          <div class="temp-icon">üíß</div>
          <div class="reading-value humidity" id="humidity-value">--</div>
          <div>%</div>
        </div>
      </div>
      
      <div class="min-max-readings">
        <div class="min-max-card">
          <h3>Temperatura M√≠nima</h3>
          <div class="min-value" id="min-temp">--</div>
          <div>¬∞C</div>
        </div>
        
        <div class="min-max-card">
          <h3>Temperatura M√°xima</h3>
          <div class="max-value" id="max-temp">--</div>
          <div>¬∞C</div>
        </div>
        
        <button id="reset-min-max" class="reset-min-max">Reiniciar Min/Max</button>
      </div>
      
      <div id="status-indicator" class="status-indicator status-ok">Estado: OK</div>
      
      <div class="chart-container">
        <div class="chart-controls">
          <button id="refresh-chart" class="refresh-btn">
            <span class="refresh-icon">üîÑ</span> Actualizar gr√°fica
          </button>
        </div>
        <canvas id="sensorChart"></canvas>
      </div>
      
      <div class="last-update" id="last-update">√öltima actualizaci√≥n: --</div>
      
 <!-- Secci√≥n de Configuraci√≥n de Alertas de Telegram con el cambio solicitado -->
 <div class="telegram-config-section">
    <h2><span class="telegram-icon">üì≤</span> Configuraci√≥n de Alertas de Telegram</h2>
    
    <div class="config-form">
      <div>
        <div class="form-group">
          <label for="telegram-active">Activar Alertas de Telegram</label>
          <label class="form-switch">
            <input type="checkbox" id="telegram-active">
            <span id="telegram-status-text">Alertas desactivadas</span>
          </label>
        </div>
        
        <div class="form-group">
          <label for="temp-threshold">L√≠mite de Temperatura (¬∞C)</label>
          <input type="number" id="temp-threshold" class="form-control" min="0" max="100" value="30" step="0.5">
        </div>

        <div class="form-group">
          <label for="alert-cooldown">Tiempo entre alertas</label>
          <div class="input-group">
            <input type="number" id="alert-cooldown" class="form-control" min="1" max="120" value="10">
            <select id="cooldown-unit" class="form-select">
              <option value="seconds">Segundos</option>
              <option value="minutes" selected>Minutos</option>
            </select>
          </div>
          <small style="color: #6c757d;">Tiempo m√≠nimo que debe pasar antes de enviar otra alerta</small>
        </div>
      </div>
      
      <div>
        <div class="form-group">
          <label for="recipient-name">Nombre del Destinatario</label>
          <input type="text" id="recipient-name" class="form-control" placeholder="Nombre">
        </div>
        
        <div class="form-group">
          <label for="chat-id">ID de Chat de Telegram</label>
          <input type="text" id="chat-id" class="form-control" placeholder="Ej: 123456789">
        </div>
        
        <div class="form-group">
          <label for="bot-token">Token del Bot</label>
          <input type="password" id="bot-token" class="form-control" placeholder="Token del bot">
          <small style="color: #6c757d;">Nunca compartiremos tus credenciales con nadie.</small>
        </div>
      </div>
    </div>
    
    <button id="save-telegram-config" class="btn btn-primary">
      <span>üíæ</span> Guardar Configuraci√≥n
    </button>
    
    <button id="test-telegram" class="btn btn-test">
      <span>üß™</span> Probar Alerta
    </button>
    
    <div class="recipient-info">
      <h3>Informaci√≥n de Alertas</h3>
      <div>Estado: <span id="alert-status" class="alert-badge alert-badge-inactive">Desactivado</span></div>
      <div>√öltima alerta: <span id="last-alert-time">Nunca</span></div>
      <div>√öltima verificaci√≥n: <span id="last-check-time">Nunca</span></div>
      <div>Pr√≥xima verificaci√≥n: <span id="next-check-time">-</span></div>
      <div id="alert-history-container"></div>
    </div>
  </div>

    <div class="footer">
      <p>ESP32 + Firebase + Sensor DHT</p>
    </div>
  </div>
</div>

      <div class="footer">
        <p>ESP32 + Firebase + Sensor DHT</p>
      </div>
    </div>
  </div>

<script>
    const firebaseConfig = {
  apiKey: "AIzaSyA6L6vcWsQcaucQTjmz7svKrCo1t0L-M6c",
  authDomain: "esp32-93fbb.firebaseapp.com",
  databaseURL: "https://esp32-93fbb-default-rtdb.firebaseio.com",
  projectId: "esp32-93fbb",
  storageBucket: "esp32-93fbb.firebasestorage.app",
  messagingSenderId: "623403559263",
  appId: "1:623403559263:web:afdd3dca5dddf9d6346eea",
  measurementId: "G-XWZK0QF50D"
};

let telegramConfig = {
  active: false,
  tempThreshold: 30,
  cooldown: 10, // valor num√©rico
  cooldownUnit: 'minutes', // 'seconds' o 'minutes'
  recipientName: '',
  chatId: '',
  botToken: '',
  lastAlert: null,
  lastCheck: null
};

// Elementos del DOM
const tempValue = document.getElementById('temp-value');
const humidityValue = document.getElementById('humidity-value');
const lastUpdate = document.getElementById('last-update');
const statusIndicator = document.getElementById('status-indicator');
const loadingElement = document.getElementById('loading');
const dashboardContent = document.getElementById('dashboard-content');
const errorMessage = document.getElementById('error-message');
const tempDescriptor = document.getElementById('temp-descriptor');
const tempIcon = document.getElementById('temp-icon');
const bodyElement = document.body;
const checkbox = document.getElementById('checkbox');
const connectionIndicator = document.getElementById('connection-indicator');
const connectionText = document.getElementById('connection-text');
const minTempElement = document.getElementById('min-temp');
const maxTempElement = document.getElementById('max-temp');
const resetMinMaxButton = document.getElementById('reset-min-max');
const telegramActiveSwitch = document.getElementById('telegram-active');
const tempThresholdInput = document.getElementById('temp-threshold');
const alertCooldownInput = document.getElementById('alert-cooldown');
const cooldownUnitSelect = document.getElementById('cooldown-unit');
const recipientNameInput = document.getElementById('recipient-name');
const chatIdInput = document.getElementById('chat-id');
const botTokenInput = document.getElementById('bot-token');
const saveConfigButton = document.getElementById('save-telegram-config');
const testTelegramButton = document.getElementById('test-telegram');
const telegramStatusText = document.getElementById('telegram-status-text');
const alertStatusElement = document.getElementById('alert-status');
const lastAlertTimeElement = document.getElementById('last-alert-time');
const lastCheckTimeElement = document.getElementById('last-check-time');
const nextCheckTimeElement = document.getElementById('next-check-time');
const alertHistoryContainer = document.getElementById('alert-history-container');   

// Variables para almacenar datos hist√≥ricos y temperaturas extremas
let historicalData = {
  timestamps: [],
  temperatures: [],
  humidities: []
};

// Variables para almacenar temperaturas m√°ximas y m√≠nimas
let minTemp = Infinity;
let maxTemp = -Infinity;

// Funci√≥n para actualizar los valores de temperatura m√°xima y m√≠nima
function updateMinMaxTemps(currentTemp) {
  // Convertir a n√∫mero para asegurar comparaci√≥n correcta
  const temp = parseFloat(currentTemp);
  
  // Actualizar temperatura m√≠nima si es necesario
  if (temp < minTemp) {
    minTemp = temp;
    // Animaci√≥n para el cambio
    minTempElement.style.transform = 'scale(1.2)';
    setTimeout(() => {
      minTempElement.style.transform = 'scale(1)';
    }, 500);
  }
  
  // Actualizar temperatura m√°xima si es necesario
  if (temp > maxTemp) {
    maxTemp = temp;
    // Animaci√≥n para el cambio
    maxTempElement.style.transform = 'scale(1.2)';
    setTimeout(() => {
      maxTempElement.style.transform = 'scale(1)';
    }, 500);
  }
  
  // Actualizar valores en pantalla
  minTempElement.textContent = minTemp.toFixed(1);
  maxTempElement.textContent = maxTemp.toFixed(1);
}

// Funci√≥n para reiniciar los valores m√≠nimos y m√°ximos
function resetMinMaxTemps() {
  // Animaci√≥n para el reinicio
  minTempElement.style.transform = 'scale(0.8)';
  maxTempElement.style.transform = 'scale(0.8)';
  
  setTimeout(() => {
    // Reiniciar a valores actuales
    const currentTemp = parseFloat(tempValue.textContent);
    minTemp = currentTemp;
    maxTemp = currentTemp;
    
    // Actualizar en pantalla
    minTempElement.textContent = minTemp.toFixed(1);
    maxTempElement.textContent = maxTemp.toFixed(1);
    
    // Restaurar tama√±o
    minTempElement.style.transform = 'scale(1)';
    maxTempElement.style.transform = 'scale(1)';
  }, 300);
}

// Evento para el bot√≥n de reinicio de min/max
resetMinMaxButton.addEventListener('click', resetMinMaxTemps);

// Manejar cambio de modo sin localStorage
checkbox.addEventListener('change', function() {
  if (this.checked) {
    bodyElement.classList.add('dark-mode');
    // Si hay un gr√°fico inicializado, actualizar el tema
    if (window.sensorChart) {
      updateChartTheme(true);
      window.sensorChart.update();
    }
  } else {
    bodyElement.classList.remove('dark-mode');
    // Si hay un gr√°fico inicializado, actualizar el tema
    if (window.sensorChart) {
      updateChartTheme(false);
      window.sensorChart.update();
    }
  }
});

// Funci√≥n para actualizar el tema del gr√°fico
function updateChartTheme(darkMode) {
  // Actualizar la configuraci√≥n del tema del gr√°fico
  if (window.sensorChart) {
    const chartOptions = window.sensorChart.options;
    
    // Colores de texto
    const textColor = darkMode ? '#f0f0f0' : '#666';
    const gridColor = darkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
    
    // Actualizar colores
    chartOptions.scales.x.ticks.color = textColor;
    chartOptions.scales.x.title.color = textColor;
    chartOptions.scales.y.ticks.color = textColor;
    chartOptions.scales.y.title.color = textColor;
    chartOptions.scales.y1.ticks.color = textColor;
    chartOptions.scales.y1.title.color = textColor;
    chartOptions.scales.x.grid.color = gridColor;
    chartOptions.scales.y.grid.color = gridColor;
    chartOptions.scales.y1.grid.color = gridColor;
    chartOptions.plugins.legend.labels.color = textColor;
  }
}

// Funci√≥n para actualizar el estado de conexi√≥n
function updateConnectionStatus(status) {
  connectionIndicator.className = 'connection-indicator';
  
  switch(status) {
    case 'online':
      connectionIndicator.classList.add('connection-online');
      connectionText.textContent = 'Conectado a Firebase';
      break;
    case 'offline':
      connectionIndicator.classList.add('connection-offline');
      connectionText.textContent = 'Desconectado de Firebase';
      break;
    default:
      connectionIndicator.classList.add('connection-waiting');
      connectionText.textContent = 'Verificando conexi√≥n...';
  }
}

// Funci√≥n para formatear la fecha
function formatDate(date) {
  return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
}

// Funci√≥n para actualizar el indicador de estado
function updateStatusIndicator(status) {
  statusIndicator.textContent = `Estado: ${status}`;
  statusIndicator.className = 'status-indicator';
  
  if (status === 'OK') {
    statusIndicator.classList.add('status-ok');
  } else if (status === 'WARNING') {
    statusIndicator.classList.add('status-warning');
  } else {
    statusIndicator.classList.add('status-error');
  }
}

// Funci√≥n para actualizar el estilo basado en la temperatura
function updateTemperatureStyle(temperature) {
  // Remover todas las clases de temperatura
  bodyElement.classList.remove('temp-cold', 'temp-cool', 'temp-mild', 'temp-warm', 'temp-hot', 'temp-very-hot');
  tempDescriptor.classList.remove('temp-cold-text', 'temp-mild-text', 'temp-warm-text', 'temp-hot-text');
  
  // Determinar clase y descripci√≥n seg√∫n rango de temperatura
  let tempClass = '';
  let tempTextClass = '';
  let description = '';
  let iconEmoji = '';
  
  if (temperature <= 15) {
    tempClass = 'temp-cold';
    tempTextClass = 'temp-cold-text';
    description = 'Muy fr√≠o';
    iconEmoji = '‚ùÑÔ∏è';
  } else if (temperature <= 20) {
    tempClass = 'temp-cool';
    tempTextClass = 'temp-cold-text';
    description = 'Fr√≠o';
    iconEmoji = 'üßä';
  } else if (temperature <= 24) {
    tempClass = 'temp-mild';
    tempTextClass = 'temp-mild-text';
    description = 'Fresco';
    iconEmoji = 'üå§Ô∏è';
  } else if (temperature <= 28) {
    tempClass = 'temp-warm';
    tempTextClass = 'temp-mild-text';
    description = 'Templado';
    iconEmoji = '‚òÄÔ∏è';
  } else if (temperature <= 32) {
    tempClass = 'temp-hot';
    tempTextClass = 'temp-warm-text';
    description = 'Caluroso';
    iconEmoji = 'üî•';
  } else {
    tempClass = 'temp-very-hot';
    tempTextClass = 'temp-hot-text';
    description = 'Muy caluroso';
    iconEmoji = 'üî•üî•';
  }
  
  // Aplicar clases con animaci√≥n
  bodyElement.classList.add(tempClass);
  
  // Animaci√≥n suave para el cambio de clase del descriptor
  tempDescriptor.style.opacity = 0;
  setTimeout(() => {
    tempDescriptor.classList.add(tempTextClass);
    tempDescriptor.textContent = description;
    tempDescriptor.style.opacity = 1;
  }, 300);
  
  // Animaci√≥n para el cambio de icono
  tempIcon.style.transform = 'scale(0)';
  setTimeout(() => {
    tempIcon.textContent = iconEmoji;
    tempIcon.style.transform = 'scale(1)';
  }, 300);
}

// Funci√≥n para actualizar los valores actuales
function updateCurrentValues(temp, humidity, status) {
  // Animaciones para los cambios de valor
  tempValue.style.transform = 'scale(0.8)';
  humidityValue.style.transform = 'scale(0.8)';
  
  setTimeout(() => {
    tempValue.textContent = temp.toFixed(1);
    humidityValue.textContent = humidity.toFixed(1);
    
    tempValue.style.transform = 'scale(1)';
    humidityValue.style.transform = 'scale(1)';
    
    updateStatusIndicator(status || 'OK');
    updateTemperatureStyle(temp);
    
    // Actualizar valores min/max
    updateMinMaxTemps(temp);
    
    const date = new Date();
    lastUpdate.textContent = `√öltima actualizaci√≥n: ${formatDate(date)}`;
  }, 300);
}

// Funci√≥n para actualizar el tiempo de √∫ltima verificaci√≥n
function updateLastCheckTime() {
  const now = new Date();
  telegramConfig.lastCheck = now.toISOString();
  
  // Actualizar solo el campo lastCheck en Firebase
  firebase.database().ref('telegramConfig/lastCheck').set(telegramConfig.lastCheck)
    .catch(error => {
      console.error("Error al actualizar lastCheck:", error);
    });
}

// Funci√≥n para actualizar el tiempo de √∫ltima alerta
function updateLastAlertTime() {
  const now = new Date();
  telegramConfig.lastAlert = now.toISOString();
  
  // Actualizar solo el campo lastAlert en Firebase
  firebase.database().ref('telegramConfig/lastAlert').set(telegramConfig.lastAlert)
    .catch(error => {
      console.error("Error al actualizar lastAlert:", error);
    });
}

// Funci√≥n para cargar la configuraci√≥n desde Firebase
function loadTelegramConfig() {
  // Referencia a la configuraci√≥n de Telegram en Firebase
  const telegramConfigRef = firebase.database().ref('telegramConfig');
  
  // Obtener la configuraci√≥n
  telegramConfigRef.once('value')
    .then((snapshot) => {
      if (snapshot.exists()) {
        const savedConfig = snapshot.val();
        telegramConfig = { ...telegramConfig, ...savedConfig };
        
        // Compatibilidad con configuraciones antiguas
        if (savedConfig.intervalUnit && !savedConfig.cooldownUnit) {
          telegramConfig.cooldownUnit = savedConfig.intervalUnit;
        }
        if (savedConfig.checkInterval && !savedConfig.cooldown) {
          telegramConfig.cooldown = savedConfig.checkInterval;
        }
        
        // Actualizar UI con la configuraci√≥n cargada
        telegramActiveSwitch.checked = telegramConfig.active;
        tempThresholdInput.value = telegramConfig.tempThreshold;
        alertCooldownInput.value = telegramConfig.cooldown;
        
        // Usar cooldownUnit si existe, sino usar intervalUnit para compatibilidad
        if (telegramConfig.cooldownUnit) {
          cooldownUnitSelect.value = telegramConfig.cooldownUnit;
        } else if (telegramConfig.intervalUnit) {
          cooldownUnitSelect.value = telegramConfig.intervalUnit;
        }
        
        recipientNameInput.value = telegramConfig.recipientName;
        chatIdInput.value = telegramConfig.chatId;
        botTokenInput.value = telegramConfig.botToken;
        
        updateTelegramStatus();
      }
    })
    .catch((error) => {
      console.error("Error al cargar configuraci√≥n de Firebase:", error);
    });
}

// Configurar listener para cambios en la configuraci√≥n
function setupTelegramConfigListener() {
  const telegramConfigRef = firebase.database().ref('telegramConfig');
  telegramConfigRef.on('value', (snapshot) => {
    if (snapshot.exists()) {
      const savedConfig = snapshot.val();
      telegramConfig = { ...telegramConfig, ...savedConfig };
      
      // Compatibilidad con configuraciones antiguas
      if (savedConfig.intervalUnit && !savedConfig.cooldownUnit) {
        telegramConfig.cooldownUnit = savedConfig.intervalUnit;
      }
      
      // Actualizar UI solo si los valores han cambiado
      if (telegramActiveSwitch.checked !== telegramConfig.active) {
        telegramActiveSwitch.checked = telegramConfig.active;
      }
      
      if (tempThresholdInput.value != telegramConfig.tempThreshold) {
        tempThresholdInput.value = telegramConfig.tempThreshold;
      }
      
      if (alertCooldownInput.value != telegramConfig.cooldown) {
        alertCooldownInput.value = telegramConfig.cooldown;
      }
      
      if (cooldownUnitSelect.value !== telegramConfig.cooldownUnit) {
        cooldownUnitSelect.value = telegramConfig.cooldownUnit || 'minutes';
      }
      
      if (recipientNameInput.value !== telegramConfig.recipientName) {
        recipientNameInput.value = telegramConfig.recipientName;
      }
      
      if (chatIdInput.value !== telegramConfig.chatId) {
        chatIdInput.value = telegramConfig.chatId;
      }
      
      if (botTokenInput.value !== telegramConfig.botToken) {
        botTokenInput.value = telegramConfig.botToken;
      }
      
      updateTelegramStatus();
    }
  });
}

// Funci√≥n para guardar la configuraci√≥n en Firebase
function saveTelegramConfig() {
  // Actualizar objeto de configuraci√≥n
  telegramConfig.active = document.getElementById('telegram-active').checked;
  telegramConfig.tempThreshold = parseFloat(document.getElementById('temp-threshold').value);
  telegramConfig.cooldown = parseInt(document.getElementById('alert-cooldown').value);
  telegramConfig.cooldownUnit = document.getElementById('cooldown-unit').value;
  telegramConfig.recipientName = document.getElementById('recipient-name').value;
  telegramConfig.chatId = document.getElementById('chat-id').value;
  telegramConfig.botToken = document.getElementById('bot-token').value;
  
  // Compatibilidad con la versi√≥n anterior - copiar valores a los campos antiguos
  // para garantizar que el sistema siga funcionando si hay c√≥digo que depende de ellos
  telegramConfig.checkInterval = telegramConfig.cooldown;
  telegramConfig.intervalUnit = telegramConfig.cooldownUnit;
  
  // Referencia a la configuraci√≥n en Firebase
  const telegramConfigRef = firebase.database().ref('telegramConfig');
  
  // Guardar en Firebase
  telegramConfigRef.set(telegramConfig)
    .then(() => {
      console.log("Configuraci√≥n guardada correctamente en Firebase");
      updateTelegramStatus();
      
      // Mostrar confirmaci√≥n
      alert("¬°Configuraci√≥n guardada correctamente en Firebase!");
    })
    .catch((error) => {
      console.error("Error al guardar configuraci√≥n en Firebase:", error);
      alert("Error al guardar la configuraci√≥n. Int√©ntalo de nuevo.");
    });
}

// Actualizar estado visual de Telegram
function updateTelegramStatus() {
  // Acceder a los elementos directamente con getElementById
  const telegramStatusText = document.getElementById('telegram-status-text');
  const alertStatusElement = document.getElementById('alert-status');
  const lastAlertTimeElement = document.getElementById('last-alert-time');
  const lastCheckTimeElement = document.getElementById('last-check-time');
  const nextCheckTimeElement = document.getElementById('next-check-time');

  if (telegramStatusText) {
    telegramStatusText.textContent = telegramConfig.active ? 'Alertas activadas' : 'Alertas desactivadas';
  }
  
  if (alertStatusElement) {
    alertStatusElement.textContent = telegramConfig.active ? 'Activado' : 'Desactivado';
    alertStatusElement.className = telegramConfig.active ? 'alert-badge alert-badge-active' : 'alert-badge alert-badge-inactive';
  }
  
  if (lastAlertTimeElement) {
    if (telegramConfig.lastAlert) {
      const lastAlertDate = new Date(telegramConfig.lastAlert);
      lastAlertTimeElement.textContent = formatDate(lastAlertDate);
    } else {
      lastAlertTimeElement.textContent = 'Nunca';
    }
  }
  
  if (lastCheckTimeElement) {
    if (telegramConfig.lastCheck) {
      const lastCheckDate = new Date(telegramConfig.lastCheck);
      lastCheckTimeElement.textContent = formatDate(lastCheckDate);
      
      if (nextCheckTimeElement) {
        const nextCheckDate = new Date(lastCheckDate);
        // Calcular la pr√≥xima verificaci√≥n usando la unidad de tiempo entre alertas
        if (telegramConfig.cooldownUnit === 'seconds') {
          nextCheckDate.setSeconds(nextCheckDate.getSeconds() + parseInt(telegramConfig.cooldown));
        } else {
          nextCheckDate.setMinutes(nextCheckDate.getMinutes() + parseInt(telegramConfig.cooldown));
        }
        
        nextCheckTimeElement.textContent = formatDate(nextCheckDate);
      }
    } else {
      lastCheckTimeElement.textContent = 'Nunca';
      if (nextCheckTimeElement) {
        nextCheckTimeElement.textContent = '-';
      }
    }
  }
}

// Enviar mensaje de prueba por Telegram
function sendTestMessage() {
  if (!telegramConfig.chatId || !telegramConfig.botToken) {
    alert("Por favor, primero configura un ID de chat y token de bot v√°lidos.");
    return;
  }
  
  const testTemp = parseFloat(tempValue.textContent);
  sendTelegramAlert(testTemp, true);
}

// Enviar alerta por Telegram
function sendTelegramAlert(temperature, isTest = false) {
  if (!telegramConfig.active && !isTest) return;
  
  // Verificar per√≠odo de enfriamiento para evitar spam
  const now = new Date();
  if (telegramConfig.lastAlert && !isTest) {
    const lastAlertTime = new Date(telegramConfig.lastAlert);
    
    // Calcular diferencia seg√∫n la unidad seleccionada
    let diffTime;
    if (telegramConfig.cooldownUnit === 'seconds') {
      diffTime = (now - lastAlertTime) / 1000; // segundos
    } else {
      diffTime = (now - lastAlertTime) / (1000 * 60); // minutos
    }
    
    if (diffTime < telegramConfig.cooldown) {
      const timeLeft = Math.ceil(telegramConfig.cooldown - diffTime);
      const unit = telegramConfig.cooldownUnit === 'seconds' ? 'segundos' : 'minutos';
      console.log(`Alerta en enfriamiento. Pr√≥xima alerta disponible en ${timeLeft} ${unit}.`);
      return;
    }
  }
  
  const message = isTest 
    ? `üß™ MENSAJE DE PRUEBA üß™\nHola ${telegramConfig.recipientName}, la temperatura actual es de ${temperature.toFixed(1)}¬∞C.`
    : `‚ö†Ô∏è ALERTA DE TEMPERATURA ‚ö†Ô∏è\nHola ${telegramConfig.recipientName}, la temperatura ha superado el l√≠mite establecido (${telegramConfig.tempThreshold}¬∞C).\nTemperatura actual: ${temperature.toFixed(1)}¬∞C.`;
  
  const url = `https://api.telegram.org/bot${telegramConfig.botToken}/sendMessage?chat_id=${telegramConfig.chatId}&text=${encodeURIComponent(message)}`;
  
  fetch(url)
    .then(response => response.json())
    .then(data => {
      if (data.ok) {
        console.log("Mensaje enviado con √©xito");
        
        // Actualizar √∫ltimo tiempo de alerta en Firebase
        updateLastAlertTime();
        
        // Tambi√©n actualizar el √∫ltimo tiempo de verificaci√≥n
        updateLastCheckTime();
        
        // Agregar a historial de alertas
        addAlertToHistory(temperature, isTest);
        
      } else {
        console.error("Error al enviar mensaje:", data.description);
        alert(`Error al enviar mensaje: ${data.description}`);
      }
    })
    .catch(error => {
      console.error("Error en la solicitud:", error);
      alert("Error al enviar el mensaje. Verifica tu conexi√≥n a internet.");
    });
}

// Agregar alerta al historial
function addAlertToHistory(temperature, isTest) {
  const now = new Date();
  const alertItem = document.createElement('div');
  alertItem.className = 'alert-item slide-enter';
  alertItem.innerHTML = `
    <div>
        ${isTest ? 'üß™ Prueba:' : '‚ö†Ô∏è Alerta:'} 
        <span class="alert-item-temp">${temperature.toFixed(1)}¬∞C</span>
    </div>
    <div class="alert-item-time">${formatDate(now)}</div>
    `;
    
    alertHistoryContainer.prepend(alertItem);
    
  // Limitar historial a los √∫ltimos 5 elementos
    if (alertHistoryContainer.children.length > 5) {
    alertHistoryContainer.removeChild(alertHistoryContainer.lastChild);
    }
    
  // Tambi√©n guardar el historial en Firebase
    const alertHistoryRef = firebase.database().ref('telegramConfig/alertHistory');
    alertHistoryRef.once('value')
    .then((snapshot) => {
        let history = [];
        if (snapshot.exists()) {
        history = snapshot.val();
        }
        
      // A√±adir nueva alerta al principio
        history.unshift({
        timestamp: now.toISOString(),
        temperature: temperature,
        isTest: isTest
      });
      
      // Limitar a los √∫ltimos 20 elementos
      if (history.length > 20) {
        history = history.slice(0, 20);
      }
      
      // Guardar en Firebase
      alertHistoryRef.set(history);
    })
    .catch((error) => {
      console.error("Error al guardar historial:", error);
    });
}

// Verificar temperatura para alertas
function checkTemperatureForAlert(temperature) {
  if (!telegramConfig.active) return;
  
  // Verificar si la temperatura supera el umbral
  if (temperature > telegramConfig.tempThreshold) {
    // Actualizar el tiempo de verificaci√≥n
    updateLastCheckTime();
    
    // Enviar alerta si es necesario
    sendTelegramAlert(temperature);
  }
}

// Event listeners para botones de Telegram
saveConfigButton.addEventListener('click', saveTelegramConfig);
testTelegramButton.addEventListener('click', sendTestMessage);
telegramActiveSwitch.addEventListener('change', function() {
  telegramStatusText.textContent = this.checked ? 'Alertas activadas' : 'Alertas desactivadas';
});

// Inicializar Firebase
try {
  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();
  const sensorRef = database.ref('sensor');
  
  // Monitorear el estado de conexi√≥n
  const connectedRef = database.ref('.info/connected');
  connectedRef.on('value', (snap) => {
    if (snap.val() === true) {
      updateConnectionStatus('online');
    } else {
      updateConnectionStatus('offline');
    }
  });
  
  // Datos para el gr√°fico
  const chartData = {
    labels: [],
    datasets: [
      {
        label: 'Temperatura (¬∞C)',
        data: [],
        borderColor: '#dc3545',
        backgroundColor: 'rgba(220, 53, 69, 0.1)',
        yAxisID: 'y',
        tension: 0.3,
        pointRadius: 3
      },
      {
        label: 'Humedad (%)',
        data: [],
        borderColor: '#0d6efd',
        backgroundColor: 'rgba(13, 110, 253, 0.1)',
        yAxisID: 'y1',
        tension: 0.3,
        pointRadius: 3
      }
    ]
  };
  
  // Configuraci√≥n del gr√°fico
  const chartConfig = {
    type: 'line',
    data: chartData,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: {
        mode: 'index',
        intersect: false,
      },
      stacked: false,
      animation: {
        duration: 1000,
        easing: 'easeOutQuart'
      },
      plugins: {
        legend: {
          position: 'top',
          labels: {
            boxWidth: 12,
            usePointStyle: true,
            color: bodyElement.classList.contains('dark-mode') ? '#f0f0f0' : '#666'
          }
        },
        tooltip: {
          backgroundColor: bodyElement.classList.contains('dark-mode') ? 'rgba(30, 30, 42, 0.8)' : 'rgba(0, 0, 0, 0.7)',
          padding: 10,
          cornerRadius: 5,
          animations: {
            properties: ['x', 'y', 'width', 'height', 'caretX', 'caretY'],
            duration: 400
          }
        }
      },
      scales: {
        x: {
          title: {
            display: true,
            text: 'Tiempo',
            color: bodyElement.classList.contains('dark-mode') ? '#f0f0f0' : '#666'
          },
          ticks: {
            maxRotation: 45,
            minRotation: 45,
            autoSkip: true,
            maxTicksLimit: 10,
            color: bodyElement.classList.contains('dark-mode') ? '#f0f0f0' : '#666'
          },
          grid: {
            color: bodyElement.classList.contains('dark-mode') ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
          }
        },
        y: {
          type: 'linear',
          display: true,
          position: 'left',
          title: {
            display: true,
            text: 'Temperatura (¬∞C)',
            color: bodyElement.classList.contains('dark-mode') ? '#f0f0f0' : '#666'
          },
          min: 0,
          suggestedMax: 40,
          ticks: {
            stepSize: 5,
            color: bodyElement.classList.contains('dark-mode') ? '#f0f0f0' : '#666'
          },
          grid: {
            color: bodyElement.classList.contains('dark-mode') ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
          }
        },
        y1: {
          type: 'linear',
          display: true,
          position: 'right',
          title: {
            display: true,
            text: 'Humedad (%)',
            color: bodyElement.classList.contains('dark-mode') ? '#f0f0f0' : '#666'
          },
          min: 0,
          max: 100,
          grid: {
            drawOnChartArea: false,
            color: bodyElement.classList.contains('dark-mode') ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
          },
          ticks: {
            stepSize: 10,
            color: bodyElement.classList.contains('dark-mode') ? '#f0f0f0' : '#666'
          }
        },
      }
    },
  };
  
  // Crear el gr√°fico
  const ctx = document.getElementById('sensorChart').getContext('2d');
  window.sensorChart = new Chart(ctx, chartConfig);
  
  // Funci√≥n para actualizar el gr√°fico con nuevos datos
  function updateChartData(timestamp) {
    const now = new Date();
    const timeStr = now.getHours().toString().padStart(2, '0') + ':' + 
                   now.getMinutes().toString().padStart(2, '0');
    
    // Guardar datos hist√≥ricos
    historicalData.timestamps.push(timestamp);
    historicalData.temperatures.push(parseFloat(tempValue.textContent));
    historicalData.humidities.push(parseFloat(humidityValue.textContent));
    
    // Limitamos a los √∫ltimos 20 puntos de datos para mejor visualizaci√≥n
    if (historicalData.timestamps.length > 20) {
      historicalData.timestamps.shift();
      historicalData.temperatures.shift();
      historicalData.humidities.shift();
    }
    
    // Actualizar datos del gr√°fico
    chartData.labels = historicalData.timestamps.map(ts => {
      const d = new Date(ts);
      return d.getHours().toString().padStart(2, '0') + ':' + 
            d.getMinutes().toString().padStart(2, '0');
    });
    
    chartData.datasets[0].data = historicalData.temperatures;
    chartData.datasets[1].data = historicalData.humidities;
    
    // Actualizar el gr√°fico
    window.sensorChart.update();
  }
  
  // Escuchar cambios en tiempo real desde Firebase
  sensorRef.on('value', (snapshot) => {
    const data = snapshot.val();
    
    // Ocultar cargando con animaci√≥n y mostrar contenido
    loadingElement.style.opacity = 0;
    setTimeout(() => {
      loadingElement.style.display = 'none';
      dashboardContent.style.display = 'block';
      
      // Inicializar valores min/max con el primer valor recibido
      if (minTemp === Infinity && maxTemp === -Infinity && data) {
        minTemp = data.temperature;
        maxTemp = data.temperature;
        minTempElement.textContent = minTemp.toFixed(1);
        maxTempElement.textContent = maxTemp.toFixed(1);
      }
      
      // Agregar animaci√≥n al mostrar el contenido
      setTimeout(() => {
        dashboardContent.style.opacity = 1;
      }, 100);
    }, 500);
    
    // Actualizar valores actuales
    if (data) {
      updateCurrentValues(data.temperature, data.humidity, data.status);
      updateChartData(Date.now());
    }
  }, (error) => {
    console.error("Error al leer datos:", error);
    loadingElement.style.opacity = 0;
    setTimeout(() => {
      loadingElement.style.display = 'none';
      errorMessage.style.display = 'block';
      updateConnectionStatus('offline');
    }, 500);
  });
  
  // Inicializar con datos simulados hasta recibir datos reales
  // Esto es solo para dar una idea visual al usuario antes de que lleguen datos reales
  for (let i = 0; i < 10; i++) {
    const timestamp = Date.now() - (9 - i) * 60000; // Cada minuto
    const tempValue = 25 + Math.random() * 5;
    const humidityValue = 50 + Math.random() * 10;
    
    historicalData.timestamps.push(timestamp);
    historicalData.temperatures.push(tempValue);
    historicalData.humidities.push(humidityValue);
  }
  
  // Actualizar gr√°fico con datos simulados
  chartData.labels = historicalData.timestamps.map(ts => {
    const d = new Date(ts);
    return d.getHours().toString().padStart(2, '0') + ':' + 
          d.getMinutes().toString().padStart(2, '0');
  });
  
  chartData.datasets[0].data = historicalData.temperatures;
  chartData.datasets[1].data = historicalData.humidities;
  
  window.sensorChart.update();
  
  // Funci√≥n para reiniciar/actualizar el gr√°fico
  function resetChart() {
    // A√±adir animaci√≥n al bot√≥n
    const refreshBtn = document.getElementById('refresh-chart');
    const refreshIcon = refreshBtn.querySelector('.refresh-icon');
    refreshIcon.style.animation = 'spin 1s linear'; // Animar icono de actualizaci√≥n
    
    // Limpiar datos hist√≥ricos
    historicalData = {
      timestamps: [],
      temperatures: [],
      humidities: []
    };
    
    // Generar nuevos datos de ejemplo (o se podr√≠a hacer una nueva consulta a Firebase)
    for (let i = 0; i < 10; i++) {
      const timestamp = Date.now() - (9 - i) * 60000; // Cada minuto
      const tempValue = parseFloat(document.getElementById('temp-value').textContent) + (Math.random() * 2 - 1);
      const humidityValue = parseFloat(document.getElementById('humidity-value').textContent) + (Math.random() * 4 - 2);
      
      historicalData.timestamps.push(timestamp);
      historicalData.temperatures.push(tempValue);
      historicalData.humidities.push(humidityValue);
    }
    
    // Actualizar datos del gr√°fico
    chartData.labels = historicalData.timestamps.map(ts => {
      const d = new Date(ts);
      return d.getHours().toString().padStart(2, '0') + ':' + 
            d.getMinutes().toString().padStart(2, '0');
    });
    
    chartData.datasets[0].data = historicalData.temperatures;
    chartData.datasets[1].data = historicalData.humidities;
    
    // Actualizar el gr√°fico con animaci√≥n
    window.sensorChart.update('active');
    
    // Quitar la animaci√≥n despu√©s de un tiempo
    setTimeout(() => {
      refreshIcon.style.animation = '';
    }, 1000);
  }
  
  // Agregar evento click al bot√≥n de actualizaci√≥n
  document.getElementById('refresh-chart').addEventListener('click', resetChart);
  
  // Cargar configuraci√≥n de Telegram al iniciar
  loadTelegramConfig();
  
  // Configurar listener para cambios en la configuraci√≥n
  setupTelegramConfigListener();
  
  // Modificar la funci√≥n updateCurrentValues para verificar alertas
  const originalUpdateCurrentValues = updateCurrentValues;
  updateCurrentValues = function(temp, humidity, status) {
    originalUpdateCurrentValues(temp, humidity, status);
    
    // Verificar temperatura para alertas
    checkTemperatureForAlert(temp);
  };
  
} catch (error) {
  console.error("Error al inicializar Firebase:", error);
  loadingElement.style.opacity = 0;
  setTimeout(() => {
    loadingElement.style.display = 'none';
    errorMessage.style.display = 'block';
    updateConnectionStatus('offline');
  }, 500);
  errorMessage.textContent = "Error al conectar con Firebase: " + error.message;
}
</script>
</body>
</html>
