<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Monitor de Temperatura y Humedad</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-database-compat.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f5f5f5;
      color: #333;
      line-height: 1.6;
    }
    
    .container {
      width: 95%;
      max-width: 1200px;
      margin: 15px auto;
      background-color: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      padding: 20px;
      overflow: hidden;
    }
    
    h1 {
      color: #333;
      text-align: center;
      margin-bottom: 20px;
      font-size: 1.8rem;
    }
    
    @media (max-width: 600px) {
      h1 {
        font-size: 1.5rem;
      }
    }
    
    .current-readings {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-around;
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .reading-card {
      background-color: #f8f9fa;
      border-radius: 10px;
      padding: 20px;
      min-width: 150px;
      flex: 1;
      text-align: center;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
      transition: transform 0.2s ease;
    }
    
    .reading-card:hover {
      transform: translateY(-5px);
    }
    
    .reading-card h2 {
      margin-top: 0;
      color: #555;
      font-size: 1.2rem;
    }
    
    .reading-value {
      font-size: 2.5rem;
      font-weight: bold;
      margin: 10px 0;
    }
    
    @media (max-width: 600px) {
      .reading-value {
        font-size: 2rem;
      }
    }
    
    .temperature {
      color: #dc3545;
    }
    
    .humidity {
      color: #0d6efd;
    }
    
    .chart-container {
      position: relative;
      height: 50vh;
      min-height: 300px;
      width: 100%;
      margin: 20px 0;
    }
    
    .footer {
      text-align: center;
      margin-top: 20px;
      color: #6c757d;
      font-size: 0.9rem;
      padding: 10px 0;
      border-top: 1px solid #eee;
    }
    
    .last-update {
      text-align: right;
      font-size: 0.8rem;
      color: #6c757d;
      margin-top: 10px;
    }
    
    /* Estado de carga */
    .loading {
      text-align: center;
      padding: 30px;
      color: #6c757d;
    }
    
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border-left-color: #0d6efd;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .status-indicator {
      display: inline-block;
      font-size: 0.9rem;
      padding: 5px 10px;
      border-radius: 20px;
      margin-top: 10px;
    }
    
    .status-ok {
      background-color: #d4edda;
      color: #155724;
    }
    
    .status-warning {
      background-color: #fff3cd;
      color: #856404;
    }
    
    .status-error {
      background-color: #f8d7da;
      color: #721c24;
    }
    
    /* Diseño de orientación */
    @media (orientation: landscape) and (max-height: 500px) {
      .container {
        padding: 10px;
      }
      
      .current-readings {
        margin-bottom: 15px;
      }
      
      .chart-container {
        height: 40vh;
        min-height: 200px;
      }
    }
    
    /* Estilo para mensajes de error */
    .error-message {
      background-color: #f8d7da;
      color: #721c24;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      text-align: center;
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Monitor de Temperatura y Humedad</h1>
    
    <div id="error-message" class="error-message">
      Error al conectar con la base de datos. Por favor, verifica tu conexión.
    </div>
    
    <div id="loading" class="loading">
      <div class="spinner"></div>
      <p>Cargando datos...</p>
    </div>
    
    <div id="dashboard-content" style="display: none;">
      <div class="current-readings">
        <div class="reading-card">
          <h2>Temperatura</h2>
          <div class="reading-value temperature" id="temp-value">--</div>
          <div>°C</div>
        </div>
        
        <div class="reading-card">
          <h2>Humedad</h2>
          <div class="reading-value humidity" id="humidity-value">--</div>
          <div>%</div>
        </div>
      </div>
      
      <div id="status-indicator" class="status-indicator status-ok">Estado: OK</div>
      
      <div class="chart-container">
        <canvas id="sensorChart"></canvas>
      </div>
      
      <div class="last-update" id="last-update">Última actualización: --</div>
      
      <div class="footer">
        <p>ESP32 + Firebase + Sensor DHT</p>
      </div>
    </div>
  </div>

  <script>
    // Configuración de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyA6L6vcWsQcaucQTjmz7svKrCo1t0L-M6c",
      authDomain: "esp32-93fbb.firebaseapp.com",
      databaseURL: "https://esp32-93fbb-default-rtdb.firebaseio.com",
      projectId: "esp32-93fbb",
      storageBucket: "esp32-93fbb.firebasestorage.app",
      messagingSenderId: "623403559263",
      appId: "1:623403559263:web:afdd3dca5dddf9d6346eea",
      measurementId: "G-XWZK0QF50D"
    };
    
    // Elementos del DOM
    const tempValue = document.getElementById('temp-value');
    const humidityValue = document.getElementById('humidity-value');
    const lastUpdate = document.getElementById('last-update');
    const statusIndicator = document.getElementById('status-indicator');
    const loadingElement = document.getElementById('loading');
    const dashboardContent = document.getElementById('dashboard-content');
    const errorMessage = document.getElementById('error-message');
    
    // Variables para almacenar datos históricos
    let historicalData = {
      timestamps: [],
      temperatures: [],
      humidities: []
    };
    
    // Función para formatear la fecha
    function formatDate(date) {
      return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
    }
    
    // Función para actualizar el indicador de estado
    function updateStatusIndicator(status) {
      statusIndicator.textContent = `Estado: ${status}`;
      statusIndicator.className = 'status-indicator';
      
      if (status === 'OK') {
        statusIndicator.classList.add('status-ok');
      } else if (status === 'WARNING') {
        statusIndicator.classList.add('status-warning');
      } else {
        statusIndicator.classList.add('status-error');
      }
    }
    
    // Función para actualizar los valores actuales
    function updateCurrentValues(temp, humidity, status) {
      tempValue.textContent = temp.toFixed(1);
      humidityValue.textContent = humidity.toFixed(1);
      updateStatusIndicator(status || 'OK');
      
      const date = new Date();
      lastUpdate.textContent = `Última actualización: ${formatDate(date)}`;
    }
    
    // Inicializar Firebase
    try {
      firebase.initializeApp(firebaseConfig);
      const database = firebase.database();
      const sensorRef = database.ref('sensor');
      
      // Datos para el gráfico
      const chartData = {
        labels: [],
        datasets: [
          {
            label: 'Temperatura (°C)',
            data: [],
            borderColor: '#dc3545',
            backgroundColor: 'rgba(220, 53, 69, 0.1)',
            yAxisID: 'y',
            tension: 0.3,
            pointRadius: 3
          },
          {
            label: 'Humedad (%)',
            data: [],
            borderColor: '#0d6efd',
            backgroundColor: 'rgba(13, 110, 253, 0.1)',
            yAxisID: 'y1',
            tension: 0.3,
            pointRadius: 3
          }
        ]
      };
      
      // Configuración del gráfico
      const chartConfig = {
        type: 'line',
        data: chartData,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false,
          },
          stacked: false,
          plugins: {
            legend: {
              position: 'top',
              labels: {
                boxWidth: 12,
                usePointStyle: true
              }
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.7)',
              padding: 10,
              cornerRadius: 5
            }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: 'Tiempo'
              },
              ticks: {
                maxRotation: 45,
                minRotation: 45,
                autoSkip: true,
                maxTicksLimit: 10
              }
            },
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              title: {
                display: true,
                text: 'Temperatura (°C)'
              },
              min: 0,
              suggestedMax: 40,
              ticks: {
                stepSize: 5
              }
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              title: {
                display: true,
                text: 'Humedad (%)'
              },
              min: 0,
              max: 100,
              grid: {
                drawOnChartArea: false,
              },
              ticks: {
                stepSize: 10
              }
            },
          }
        },
      };
      
      // Crear el gráfico
      const ctx = document.getElementById('sensorChart').getContext('2d');
      const sensorChart = new Chart(ctx, chartConfig);
      
      // Función para actualizar el gráfico con nuevos datos
      function updateChartData(timestamp) {
        const now = new Date();
        const timeStr = now.getHours().toString().padStart(2, '0') + ':' + 
                        now.getMinutes().toString().padStart(2, '0');
        
        // Guardar datos históricos
        historicalData.timestamps.push(timestamp);
        historicalData.temperatures.push(parseFloat(tempValue.textContent));
        historicalData.humidities.push(parseFloat(humidityValue.textContent));
        
        // Limitamos a los últimos 20 puntos de datos para mejor visualización
        if (historicalData.timestamps.length > 20) {
          historicalData.timestamps.shift();
          historicalData.temperatures.shift();
          historicalData.humidities.shift();
        }
        
        // Actualizar datos del gráfico
        chartData.labels = historicalData.timestamps.map(ts => {
          const d = new Date(ts);
          return d.getHours().toString().padStart(2, '0') + ':' + 
                d.getMinutes().toString().padStart(2, '0');
        });
        
        chartData.datasets[0].data = historicalData.temperatures;
        chartData.datasets[1].data = historicalData.humidities;
        
        // Actualizar el gráfico
        sensorChart.update();
      }
      
      // Escuchar cambios en tiempo real desde Firebase
      sensorRef.on('value', (snapshot) => {
        const data = snapshot.val();
        
        // Ocultar cargando y mostrar contenido
        loadingElement.style.display = 'none';
        dashboardContent.style.display = 'block';
        
        // Actualizar valores actuales
        if (data) {
          updateCurrentValues(data.temperature, data.humidity, data.status);
          updateChartData(Date.now());
        }
      }, (error) => {
        console.error("Error al leer datos:", error);
        loadingElement.style.display = 'none';
        errorMessage.style.display = 'block';
      });
      
      // Inicializar con datos simulados hasta recibir datos reales
      // Esto es solo para dar una idea visual al usuario antes de que lleguen datos reales
      for (let i = 0; i < 10; i++) {
        const timestamp = Date.now() - (9 - i) * 60000; // Cada minuto
        const tempValue = 25 + Math.random() * 5;
        const humidityValue = 50 + Math.random() * 10;
        
        historicalData.timestamps.push(timestamp);
        historicalData.temperatures.push(tempValue);
        historicalData.humidities.push(humidityValue);
      }
      
      // Actualizar gráfico con datos simulados
      chartData.labels = historicalData.timestamps.map(ts => {
        const d = new Date(ts);
        return d.getHours().toString().padStart(2, '0') + ':' + 
              d.getMinutes().toString().padStart(2, '0');
      });
      
      chartData.datasets[0].data = historicalData.temperatures;
      chartData.datasets[1].data = historicalData.humidities;
      
      sensorChart.update();
      
      // Ajustar tamaño del gráfico en caso de cambio de orientación
      window.addEventListener('resize', () => {
        sensorChart.resize();
      });
      
    } catch (error) {
      console.error("Error al inicializar Firebase:", error);
      loadingElement.style.display = 'none';
      errorMessage.style.display = 'block';
      errorMessage.textContent = "Error al conectar con Firebase: " + error.message;
    }
  </script>
</body>
</html>