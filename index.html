<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Monitor de Temperatura y Humedad</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-database-compat.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      transition: all 0.5s ease;
    }
    
    :root {
      --background-light: linear-gradient(135deg, #6a85b6 0%, #bac8e0 100%);
      --background-dark: linear-gradient(135deg, #2c3e50 0%, #1a1a2e 100%);
      --text-light: #333;
      --text-dark: #f0f0f0;
      --card-bg-light: rgba(255, 255, 255, 0.92);
      --card-bg-dark: rgba(37, 37, 50, 0.92);
      --reading-card-light: rgba(248, 249, 250, 0.8);
      --reading-card-dark: rgba(30, 30, 42, 0.8);
      --border-light: rgba(0, 0, 0, 0.05);
      --border-dark: rgba(255, 255, 255, 0.05);
      --shadow-light: rgba(0, 0, 0, 0.15);
      --shadow-dark: rgba(0, 0, 0, 0.25);
      --footer-text-light: #6c757d;
      --footer-text-dark: #a0a0a0;
      --border-top-light: rgba(238, 238, 238, 0.7);
      --border-top-dark: rgba(70, 70, 90, 0.7);
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      margin: 0;
      padding: 0;
      background: var(--background-light);
      color: var(--text-light);
      line-height: 1.6;
      min-height: 100vh;
      transition: background 1.5s ease, color 0.5s ease;
    }
    
    body.dark-mode {
      background: var(--background-dark);
      color: var(--text-dark);
    }
    
    /* Estilos para diferentes temperaturas - Modo Claro */
    body.temp-cold {
      background: linear-gradient(135deg, #5b86e5 0%, #36d1dc 100%);
    }
    
    body.temp-cool {
      background: linear-gradient(135deg, #36d1dc 0%, #5b86e5 100%);
    }
    
    body.temp-mild {
      background: linear-gradient(135deg, #7bc6cc 0%, #be93c5 100%);
    }
    
    body.temp-warm {
      background: linear-gradient(135deg, #ffd89b 0%, #ff9d6c 100%);
    }
    
    body.temp-hot {
      background: linear-gradient(135deg, #ff9a9e 0%, #ff7966 100%);
    }
    
    body.temp-very-hot {
      background: linear-gradient(135deg, #ff7966 0%, #ff4b2b 100%);
    }
    
    /* Estilos para diferentes temperaturas - Modo Oscuro */
    body.dark-mode.temp-cold {
      background: linear-gradient(135deg, #1a2a40 0%, #253b47 100%);
    }
    
    body.dark-mode.temp-cool {
      background: linear-gradient(135deg, #253b47 0%, #1a2a40 100%);
    }
    
    body.dark-mode.temp-mild {
      background: linear-gradient(135deg, #2c3e50 0%, #3a2842 100%);
    }
    
    body.dark-mode.temp-warm {
      background: linear-gradient(135deg, #4a3636 0%, #543326 100%);
    }
    
    body.dark-mode.temp-hot {
      background: linear-gradient(135deg, #582f33 0%, #612926 100%);
    }
    
    body.dark-mode.temp-very-hot {
      background: linear-gradient(135deg, #612926 0%, #6a1b16 100%);
    }
    
    .container {
      width: 95%;
      max-width: 1200px;
      margin: 15px auto;
      background-color: var(--card-bg-light);
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
      padding: 20px;
      overflow: hidden;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      transition: background-color 0.5s ease, box-shadow 0.5s ease;
      animation: fadeIn 0.8s ease-out;
    }
    
    .dark-mode .container {
      background-color: var(--card-bg-dark);
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
    }
    
    h1 {
      color: var(--text-light);
      text-align: center;
      margin-bottom: 20px;
      font-size: 1.8rem;
      transition: color 0.5s ease;
      animation: slideDown 0.6s ease-out;
    }
    
    .dark-mode h1 {
      color: var(--text-dark);
    }
    
    @media (max-width: 600px) {
      h1 {
        font-size: 1.5rem;
      }
    }
    
    .current-readings {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-around;
      gap: 20px;
      margin-bottom: 30px;
      animation: fadeInUp 0.8s ease-out;
    }
    
    .reading-card {
      background-color: var(--reading-card-light);
      border-radius: 10px;
      padding: 20px;
      min-width: 150px;
      flex: 1;
      text-align: center;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease, background-color 0.5s ease;
      border: 1px solid var(--border-light);
      animation: pulse 2s infinite;
    }
    
    .dark-mode .reading-card {
      background-color: var(--reading-card-dark);
      border: 1px solid var(--border-dark);
      box-shadow: 0 4px 15px var(--shadow-dark);
    }
    
    .reading-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px var(--shadow-light);
    }
    
    .dark-mode .reading-card:hover {
      box-shadow: 0 8px 25px var(--shadow-dark);
    }
    
    .reading-card h2 {
      margin-top: 0;
      color: #555;
      font-size: 1.2rem;
      transition: color 0.5s ease;
    }
    
    .dark-mode .reading-card h2 {
      color: #bbb;
    }
    
    .reading-value {
      font-size: 2.5rem;
      font-weight: bold;
      margin: 10px 0;
      transition: color 0.3s ease;
    }
    
    @media (max-width: 600px) {
      .reading-value {
        font-size: 2rem;
      }
    }
    
    .temperature {
      color: #dc3545;
    }
    
    .humidity {
      color: #0d6efd;
    }
    
    .temp-icon {
      font-size: 1.8rem;
      margin: 5px 0;
      animation: bounce 2s infinite;
    }
    
    .chart-container {
      position: relative;
      height: 50vh;
      min-height: 300px;
      width: 100%;
      margin: 20px 0;
      background-color: rgba(255, 255, 255, 0.7);
      padding: 10px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      transition: background-color 0.5s ease, box-shadow 0.5s ease;
      animation: fadeIn 1s ease-out;
    }
    
    .dark-mode .chart-container {
      background-color: rgba(30, 30, 42, 0.7);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .footer {
      text-align: center;
      margin-top: 20px;
      color: var(--footer-text-light);
      font-size: 0.9rem;
      padding: 10px 0;
      border-top: 1px solid var(--border-top-light);
      transition: color 0.5s ease, border-top 0.5s ease;
    }
    
    .dark-mode .footer {
      color: var(--footer-text-dark);
      border-top: 1px solid var(--border-top-dark);
    }
    
    .last-update {
      text-align: right;
      font-size: 0.8rem;
      color: var(--footer-text-light);
      margin-top: 10px;
      transition: color 0.5s ease;
    }
    
    .dark-mode .last-update {
      color: var(--footer-text-dark);
    }
    
    /* Estado de carga */
    .loading {
      text-align: center;
      padding: 30px;
      color: var(--footer-text-light);
      transition: color 0.5s ease;
      animation: pulse 1.5s infinite;
    }
    
    .dark-mode .loading {
      color: var(--footer-text-dark);
    }
    
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border-left-color: #0d6efd;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    
    .dark-mode .spinner {
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-left-color: #0d6efd;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @keyframes fadeIn {
      0% { opacity: 0; }
      100% { opacity: 1; }
    }
    
    @keyframes fadeInUp {
      0% { opacity: 0; transform: translateY(20px); }
      100% { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.02); }
      100% { transform: scale(1); }
    }
    
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }
    
    @keyframes slideDown {
      0% { transform: translateY(-20px); opacity: 0; }
      100% { transform: translateY(0); opacity: 1; }
    }
    
    .status-indicator {
      display: inline-block;
      font-size: 0.9rem;
      padding: 8px 15px;
      border-radius: 30px;
      margin: 15px auto;
      text-align: center;
      display: block;
      max-width: 150px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      animation: pulse 2s infinite;
    }
    
    .status-ok {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .dark-mode .status-ok {
      background-color: #1e3a2d;
      color: #8fcea8;
      border: 1px solid #2c573c;
    }
    
    .status-warning {
      background-color: #fff3cd;
      color: #856404;
      border: 1px solid #ffeeba;
    }
    
    .dark-mode .status-warning {
      background-color: #3a3120;
      color: #e0c77c;
      border: 1px solid #574b27;
    }
    
    .status-error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .dark-mode .status-error {
      background-color: #3b1c1f;
      color: #dca0a6;
      border: 1px solid #57262b;
    }
    
    /* Dise√±o de orientaci√≥n */
    @media (orientation: landscape) and (max-height: 500px) {
      .container {
        padding: 10px;
      }
      
      .current-readings {
        margin-bottom: 15px;
      }
      
      .chart-container {
        height: 40vh;
        min-height: 200px;
      }
    }
    
    /* Estilo para mensajes de error */
    .error-message {
      background-color: #f8d7da;
      color: #721c24;
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
      text-align: center;
      display: none;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      border: 1px solid #f5c6cb;
      transition: all 0.5s ease;
      animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
    }
    
    .dark-mode .error-message {
      background-color: #3b1c1f;
      color: #dca0a6;
      border: 1px solid #57262b;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }
    
    @keyframes shake {
      10%, 90% { transform: translate3d(-1px, 0, 0); }
      20%, 80% { transform: translate3d(2px, 0, 0); }
      30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
      40%, 60% { transform: translate3d(4px, 0, 0); }
    }
    
    /* Temperatura descriptor */
    .temp-descriptor {
      display: block;
      text-align: center;
      margin: 10px auto 20px;
      font-size: 1.2rem;
      padding: 10px 20px;
      border-radius: 30px;
      color: white;
      font-weight: bold;
      max-width: 250px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      transition: all 0.5s ease;
      animation: fadeInUp 0.8s ease-out;
    }
    
    .temp-cold-text {
      background: linear-gradient(to right, #5b86e5, #36d1dc);
    }
    
    .dark-mode .temp-cold-text {
      background: linear-gradient(to right, #3a5c99, #257a80);
    }
    
    .temp-mild-text {
      background: linear-gradient(to right, #7bc6cc, #be93c5);
    }
    
    .dark-mode .temp-mild-text {
      background: linear-gradient(to right, #4a7a7d, #795c7e);
    }
    
    .temp-warm-text {
      background: linear-gradient(to right, #ffd89b, #ff9a9e);
    }
    
    .dark-mode .temp-warm-text {
      background: linear-gradient(to right, #a6896a, #a66669);
    }
    
    .temp-hot-text {
      background: linear-gradient(to right, #ff9a9e, #ff4b2b);
    }
    
    /* Bot√≥n para reiniciar/actualizar gr√°fica */
    .chart-controls {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 10px;
    }
    
    .refresh-btn {
      background-color: #0d6efd;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
      transition: all 0.3s ease;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    
    .refresh-btn:hover {
      background-color: #0b5ed7;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }
    
    .refresh-btn:active {
      transform: translateY(0);
    }
    
    .dark-mode .refresh-btn {
      background-color: #2d63b7;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }
    
    .dark-mode .refresh-btn:hover {
      background-color: #3a71c9;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }
    
    .refresh-icon {
      display: inline-block;
      transition: transform 0.5s ease;
    }
    
    .min-max-readings {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-around;
      gap: 15px;
      margin: 20px 0;
      animation: fadeInUp 0.8s ease-out;
    }
    
    .min-max-card {
      background-color: var(--reading-card-light);
      border-radius: 10px;
      padding: 15px;
      min-width: 120px;
      flex: 1;
      text-align: center;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
      transition: transform 0.3s ease, box-shadow 0.3s ease, background-color 0.5s ease;
      border: 1px solid var(--border-light);
    }
    
    .dark-mode .min-max-card {
      background-color: var(--reading-card-dark);
      border: 1px solid var(--border-dark);
      box-shadow: 0 3px 10px var(--shadow-dark);
    }
    
    .min-max-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    
    .dark-mode .min-max-card:hover {
      box-shadow: 0 5px 15px var(--shadow-dark);
    }
    
    .min-max-card h3 {
      margin-top: 0;
      color: #666;
      font-size: 1rem;
      margin-bottom: 8px;
      transition: color 0.5s ease;
    }
    
    .dark-mode .min-max-card h3 {
      color: #bbb;
    }
    
    .min-value {
      font-size: 1.6rem;
      font-weight: bold;
      margin: 5px 0;
      transition: color 0.3s ease;
      color: #0d6efd;
    }
    
    .max-value {
      font-size: 1.6rem;
      font-weight: bold;
      margin: 5px 0;
      transition: color 0.3s ease;
      color: #dc3545;
    }
    
    .reset-min-max {
      background-color: #6c757d;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 5px 10px;
      font-size: 0.8rem;
      cursor: pointer;
      margin-top: 10px;
      transition: background-color 0.3s ease;
    }
    
    .reset-min-max:hover {
      background-color: #5a6268;
    }
    
    .dark-mode .reset-min-max {
      background-color: #495057;
    }
    
    .dark-mode .reset-min-max:hover {
      background-color: #343a40;
    }
    .theme-switch-wrapper {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      margin-bottom: 10px;
    }
    
    .theme-switch {
      display: inline-block;
      height: 26px;
      position: relative;
      width: 50px;
    }
    
    .theme-switch input {
      display: none;
    }
    
    .slider {
      background-color: #ccc;
      bottom: 0;
      cursor: pointer;
      left: 0;
      position: absolute;
      right: 0;
      top: 0;
      transition: .4s;
      border-radius: 34px;
    }
    
    .slider:before {
      background-color: #fff;
      bottom: 4px;
      content: "";
      height: 18px;
      left: 4px;
      position: absolute;
      transition: .4s;
      width: 18px;
      border-radius: 50%;
    }
    
    input:checked + .slider {
      background-color: #2196F3;
    }
    
    input:checked + .slider:before {
      transform: translateX(24px);
    }
    
    .theme-switch-wrapper em {
      margin-right: 10px;
      font-size: 0.9rem;
      color: var(--text-light);
      transition: color 0.5s ease;
    }
    
    .dark-mode .theme-switch-wrapper em {
      color: var(--text-dark);
    }
    
    /* Estado de conexi√≥n Firebase */
    .connection-status {
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 15px auto;
      font-size: 0.9rem;
      animation: fadeIn 1s ease-out;
    }
    
    .connection-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
      transition: all 0.5s ease;
    }
    
    .connection-online {
      background-color: #28a745;
      box-shadow: 0 0 8px #28a745;
      animation: pulse 2s infinite;
    }
    
    .connection-offline {
      background-color: #dc3545;
      box-shadow: 0 0 8px #dc3545;
      animation: pulse 2s infinite;
    }
    
    .connection-waiting {
      background-color: #ffc107;
      box-shadow: 0 0 8px #ffc107;
      animation: pulse 2s infinite;
    }
    
    .connection-text {
      color: var(--footer-text-light);
      transition: color 0.5s ease;
    }
    
    .dark-mode .connection-text {
      color: var(--footer-text-dark);
    }
  </style>
</head>
<body class="temp-mild">
  <div class="container">
    <div class="theme-switch-wrapper">
      <em>Modo</em>
      <label class="theme-switch" for="checkbox">
        <input type="checkbox" id="checkbox" />
        <span class="slider"></span>
      </label>
    </div>

    <h1>Monitor de Temperatura y Humedad</h1>
    
    <div id="error-message" class="error-message">
      Error al conectar con la base de datos. Por favor, verifica tu conexi√≥n.
    </div>
    
    <div id="loading" class="loading">
      <div class="spinner"></div>
      <p>Cargando datos...</p>
    </div>
    
    <div id="dashboard-content" style="display: none;">
      <div id="temp-descriptor" class="temp-descriptor temp-mild-text">Temperatura normal</div>
      
      <div class="connection-status">
        <div id="connection-indicator" class="connection-indicator connection-waiting"></div>
        <span id="connection-text" class="connection-text">Verificando conexi√≥n...</span>
      </div>
      
      <div class="current-readings">
        <div class="reading-card">
          <h2>Temperatura</h2>
          <div id="temp-icon" class="temp-icon">üå°Ô∏è</div>
          <div class="reading-value temperature" id="temp-value">--</div>
          <div>¬∞C</div>
        </div>
        
        <div class="reading-card">
          <h2>Humedad</h2>
          <div class="temp-icon">üíß</div>
          <div class="reading-value humidity" id="humidity-value">--</div>
          <div>%</div>
        </div>
      </div>
      
      <div class="min-max-readings">
        <div class="min-max-card">
          <h3>Temperatura M√≠nima</h3>
          <div class="min-value" id="min-temp">--</div>
          <div>¬∞C</div>
        </div>
        
        <div class="min-max-card">
          <h3>Temperatura M√°xima</h3>
          <div class="max-value" id="max-temp">--</div>
          <div>¬∞C</div>
        </div>
        
        <button id="reset-min-max" class="reset-min-max">Reiniciar Min/Max</button>
      </div>
      
      <div id="status-indicator" class="status-indicator status-ok">Estado: OK</div>
      
      <div class="chart-container">
        <div class="chart-controls">
          <button id="refresh-chart" class="refresh-btn">
            <span class="refresh-icon">üîÑ</span> Actualizar gr√°fica
          </button>
        </div>
        <canvas id="sensorChart"></canvas>
      </div>
      
      <div class="last-update" id="last-update">√öltima actualizaci√≥n: --</div>
      
      <div class="footer">
        <p>ESP32 + Firebase + Sensor DHT</p>
      </div>
    </div>
  </div>

  <script>
    // Configuraci√≥n de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyA6L6vcWsQcaucQTjmz7svKrCo1t0L-M6c",
      authDomain: "esp32-93fbb.firebaseapp.com",
      databaseURL: "https://esp32-93fbb-default-rtdb.firebaseio.com",
      projectId: "esp32-93fbb",
      storageBucket: "esp32-93fbb.firebasestorage.app",
      messagingSenderId: "623403559263",
      appId: "1:623403559263:web:afdd3dca5dddf9d6346eea",
      measurementId: "G-XWZK0QF50D"
    };
    
    // Elementos del DOM
    const tempValue = document.getElementById('temp-value');
    const humidityValue = document.getElementById('humidity-value');
    const lastUpdate = document.getElementById('last-update');
    const statusIndicator = document.getElementById('status-indicator');
    const loadingElement = document.getElementById('loading');
    const dashboardContent = document.getElementById('dashboard-content');
    const errorMessage = document.getElementById('error-message');
    const tempDescriptor = document.getElementById('temp-descriptor');
    const tempIcon = document.getElementById('temp-icon');
    const bodyElement = document.body;
    const checkbox = document.getElementById('checkbox');
    const connectionIndicator = document.getElementById('connection-indicator');
    const connectionText = document.getElementById('connection-text');
    const minTempElement = document.getElementById('min-temp');
    const maxTempElement = document.getElementById('max-temp');
    const resetMinMaxButton = document.getElementById('reset-min-max');
    
    // Variables para almacenar datos hist√≥ricos y temperaturas extremas
    let historicalData = {
      timestamps: [],
      temperatures: [],
      humidities: []
    };
    
    // Variables para almacenar temperaturas m√°ximas y m√≠nimas
    let minTemp = Infinity;
    let maxTemp = -Infinity;
    
    // Funci√≥n para actualizar los valores de temperatura m√°xima y m√≠nima
    function updateMinMaxTemps(currentTemp) {
      // Convertir a n√∫mero para asegurar comparaci√≥n correcta
      const temp = parseFloat(currentTemp);
      
      // Actualizar temperatura m√≠nima si es necesario
      if (temp < minTemp) {
        minTemp = temp;
        // Animaci√≥n para el cambio
        minTempElement.style.transform = 'scale(1.2)';
        setTimeout(() => {
          minTempElement.style.transform = 'scale(1)';
        }, 500);
      }
      
      // Actualizar temperatura m√°xima si es necesario
      if (temp > maxTemp) {
        maxTemp = temp;
        // Animaci√≥n para el cambio
        maxTempElement.style.transform = 'scale(1.2)';
        setTimeout(() => {
          maxTempElement.style.transform = 'scale(1)';
        }, 500);
      }
      
      // Actualizar valores en pantalla
      minTempElement.textContent = minTemp.toFixed(1);
      maxTempElement.textContent = maxTemp.toFixed(1);
    }
    
    // Funci√≥n para reiniciar los valores m√≠nimos y m√°ximos
    function resetMinMaxTemps() {
      // Animaci√≥n para el reinicio
      minTempElement.style.transform = 'scale(0.8)';
      maxTempElement.style.transform = 'scale(0.8)';
      
      setTimeout(() => {
        // Reiniciar a valores actuales
        const currentTemp = parseFloat(tempValue.textContent);
        minTemp = currentTemp;
        maxTemp = currentTemp;
        
        // Actualizar en pantalla
        minTempElement.textContent = minTemp.toFixed(1);
        maxTempElement.textContent = maxTemp.toFixed(1);
        
        // Restaurar tama√±o
        minTempElement.style.transform = 'scale(1)';
        maxTempElement.style.transform = 'scale(1)';
      }, 300);
    }
    
    // Evento para el bot√≥n de reinicio de min/max
    resetMinMaxButton.addEventListener('click', resetMinMaxTemps);
    
    // Manejar cambio de modo sin localStorage
    checkbox.addEventListener('change', function() {
      if (this.checked) {
        bodyElement.classList.add('dark-mode');
        // Si hay un gr√°fico inicializado, actualizar el tema
        if (window.sensorChart) {
          updateChartTheme(true);
          window.sensorChart.update();
        }
      } else {
        bodyElement.classList.remove('dark-mode');
        // Si hay un gr√°fico inicializado, actualizar el tema
        if (window.sensorChart) {
          updateChartTheme(false);
          window.sensorChart.update();
        }
      }
    });
    
    // Funci√≥n para actualizar el tema del gr√°fico
    function updateChartTheme(darkMode) {
      // Actualizar la configuraci√≥n del tema del gr√°fico
      if (window.sensorChart) {
        const chartOptions = window.sensorChart.options;
        
        // Colores de texto
        const textColor = darkMode ? '#f0f0f0' : '#666';
        const gridColor = darkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
        
        // Actualizar colores
        chartOptions.scales.x.ticks.color = textColor;
        chartOptions.scales.x.title.color = textColor;
        chartOptions.scales.y.ticks.color = textColor;
        chartOptions.scales.y.title.color = textColor;
        chartOptions.scales.y1.ticks.color = textColor;
        chartOptions.scales.y1.title.color = textColor;
        chartOptions.scales.x.grid.color = gridColor;
        chartOptions.scales.y.grid.color = gridColor;
        chartOptions.scales.y1.grid.color = gridColor;
        chartOptions.plugins.legend.labels.color = textColor;
      }
    }
    
    // Funci√≥n para actualizar el estado de conexi√≥n
    function updateConnectionStatus(status) {
      connectionStatus = status;
      connectionIndicator.className = 'connection-indicator';
      
      switch(status) {
        case 'online':
          connectionIndicator.classList.add('connection-online');
          connectionText.textContent = 'Conectado a Firebase';
          break;
        case 'offline':
          connectionIndicator.classList.add('connection-offline');
          connectionText.textContent = 'Desconectado de Firebase';
          break;
        default:
          connectionIndicator.classList.add('connection-waiting');
          connectionText.textContent = 'Verificando conexi√≥n...';
      }
    }
    
    // Funci√≥n para formatear la fecha
    function formatDate(date) {
      return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
    }
    
    // Funci√≥n para actualizar el indicador de estado
    function updateStatusIndicator(status) {
      statusIndicator.textContent = `Estado: ${status}`;
      statusIndicator.className = 'status-indicator';
      
      if (status === 'OK') {
        statusIndicator.classList.add('status-ok');
      } else if (status === 'WARNING') {
        statusIndicator.classList.add('status-warning');
      } else {
        statusIndicator.classList.add('status-error');
      }
    }
    
    // Funci√≥n para actualizar el estilo basado en la temperatura
    function updateTemperatureStyle(temperature) {
      // Remover todas las clases de temperatura
      bodyElement.classList.remove('temp-cold', 'temp-cool', 'temp-mild', 'temp-warm', 'temp-hot', 'temp-very-hot');
      tempDescriptor.classList.remove('temp-cold-text', 'temp-mild-text', 'temp-warm-text', 'temp-hot-text');
      
      // Determinar clase y descripci√≥n seg√∫n rango de temperatura
      let tempClass = '';
      let tempTextClass = '';
      let description = '';
      let iconEmoji = '';
      
      if (temperature <= 15) {
        tempClass = 'temp-cold';
        tempTextClass = 'temp-cold-text';
        description = 'Muy fr√≠o';
        iconEmoji = '‚ùÑÔ∏è';
      } else if (temperature <= 20) {
        tempClass = 'temp-cool';
        tempTextClass = 'temp-cold-text';
        description = 'Fr√≠o';
        iconEmoji = 'üßä';
      } else if (temperature <= 24) {
        tempClass = 'temp-mild';
        tempTextClass = 'temp-mild-text';
        description = 'Fresco';
        iconEmoji = 'üå§Ô∏è';
      } else if (temperature <= 28) {
        tempClass = 'temp-warm';
        tempTextClass = 'temp-mild-text';
        description = 'Templado';
        iconEmoji = '‚òÄÔ∏è';
      } else if (temperature <= 32) {
        tempClass = 'temp-hot';
        tempTextClass = 'temp-warm-text';
        description = 'Caluroso';
        iconEmoji = 'üî•';
      } else {
        tempClass = 'temp-very-hot';
        tempTextClass = 'temp-hot-text';
        description = 'Muy caluroso';
        iconEmoji = 'üî•üî•';
      }
      
      // Aplicar clases con animaci√≥n
      bodyElement.classList.add(tempClass);
      
      // Animaci√≥n suave para el cambio de clase del descriptor
      tempDescriptor.style.opacity = 0;
      setTimeout(() => {
        tempDescriptor.classList.add(tempTextClass);
        tempDescriptor.textContent = description;
        tempDescriptor.style.opacity = 1;
      }, 300);
      
      // Animaci√≥n para el cambio de icono
      tempIcon.style.transform = 'scale(0)';
      setTimeout(() => {
        tempIcon.textContent = iconEmoji;
        tempIcon.style.transform = 'scale(1)';
      }, 300);
    }
    
    // Funci√≥n para actualizar los valores actuales
    function updateCurrentValues(temp, humidity, status) {
      // Animaciones para los cambios de valor
      tempValue.style.transform = 'scale(0.8)';
      humidityValue.style.transform = 'scale(0.8)';
      
      setTimeout(() => {
        tempValue.textContent = temp.toFixed(1);
        humidityValue.textContent = humidity.toFixed(1);
        
        tempValue.style.transform = 'scale(1)';
        humidityValue.style.transform = 'scale(1)';
        
        updateStatusIndicator(status || 'OK');
        updateTemperatureStyle(temp);
        
        // Actualizar valores min/max
        updateMinMaxTemps(temp);
        
        const date = new Date();
        lastUpdate.textContent = `√öltima actualizaci√≥n: ${formatDate(date)}`;
      }, 300);
    }
    
    // Inicializar Firebase
    try {
      firebase.initializeApp(firebaseConfig);
      const database = firebase.database();
      const sensorRef = database.ref('sensor');
      
      // Monitorear el estado de conexi√≥n
      const connectedRef = database.ref('.info/connected');
      connectedRef.on('value', (snap) => {
        if (snap.val() === true) {
          updateConnectionStatus('online');
        } else {
          updateConnectionStatus('offline');
        }
      });
      
      // Datos para el gr√°fico
      const chartData = {
        labels: [],
        datasets: [
          {
            label: 'Temperatura (¬∞C)',
            data: [],
            borderColor: '#dc3545',
            backgroundColor: 'rgba(220, 53, 69, 0.1)',
            yAxisID: 'y',
            tension: 0.3,
            pointRadius: 3
          },
          {
            label: 'Humedad (%)',
            data: [],
            borderColor: '#0d6efd',
            backgroundColor: 'rgba(13, 110, 253, 0.1)',
            yAxisID: 'y1',
            tension: 0.3,
            pointRadius: 3
          }
        ]
      };
      
      // Configuraci√≥n del gr√°fico
      const chartConfig = {
        type: 'line',
        data: chartData,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false,
          },
          stacked: false,
          animation: {
            duration: 1000,
            easing: 'easeOutQuart'
          },
          plugins: {
            legend: {
              position: 'top',
              labels: {
                boxWidth: 12,
                usePointStyle: true,
                color: bodyElement.classList.contains('dark-mode') ? '#f0f0f0' : '#666'
              }
            },
            tooltip: {
              backgroundColor: bodyElement.classList.contains('dark-mode') ? 'rgba(30, 30, 42, 0.8)' : 'rgba(0, 0, 0, 0.7)',
              padding: 10,
              cornerRadius: 5,
              animations: {
                properties: ['x', 'y', 'width', 'height', 'caretX', 'caretY'],
                duration: 400
              }
            }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: 'Tiempo',
                color: bodyElement.classList.contains('dark-mode') ? '#f0f0f0' : '#666'
              },
              ticks: {
                maxRotation: 45,
                minRotation: 45,
                autoSkip: true,
                maxTicksLimit: 10,
                color: bodyElement.classList.contains('dark-mode') ? '#f0f0f0' : '#666'
              },
              grid: {
                color: bodyElement.classList.contains('dark-mode') ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
              }
            },
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              title: {
                display: true,
                text: 'Temperatura (¬∞C)',
                color: bodyElement.classList.contains('dark-mode') ? '#f0f0f0' : '#666'
              },
              min: 0,
              suggestedMax: 40,
              ticks: {
                stepSize: 5,
                color: bodyElement.classList.contains('dark-mode') ? '#f0f0f0' : '#666'
              },
              grid: {
                color: bodyElement.classList.contains('dark-mode') ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
              }
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              title: {
                display: true,
                text: 'Humedad (%)',
                color: bodyElement.classList.contains('dark-mode') ? '#f0f0f0' : '#666'
              },
              min: 0,
              max: 100,
              grid: {
                drawOnChartArea: false,
                color: bodyElement.classList.contains('dark-mode') ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
              },
              ticks: {
                stepSize: 10,
                color: bodyElement.classList.contains('dark-mode') ? '#f0f0f0' : '#666'
              }
            },
          }
        },
      };
      
      // Crear el gr√°fico
      const ctx = document.getElementById('sensorChart').getContext('2d');
      window.sensorChart = new Chart(ctx, chartConfig);
      
      // Funci√≥n para actualizar el gr√°fico con nuevos datos
      function updateChartData(timestamp) {
        const now = new Date();
        const timeStr = now.getHours().toString().padStart(2, '0') + ':' + 
                        now.getMinutes().toString().padStart(2, '0');
        
        // Guardar datos hist√≥ricos
        historicalData.timestamps.push(timestamp);
        historicalData.temperatures.push(parseFloat(tempValue.textContent));
        historicalData.humidities.push(parseFloat(humidityValue.textContent));
        
        // Limitamos a los √∫ltimos 20 puntos de datos para mejor visualizaci√≥n
        if (historicalData.timestamps.length > 20) {
          historicalData.timestamps.shift();
          historicalData.temperatures.shift();
          historicalData.humidities.shift();
        }
        
        // Actualizar datos del gr√°fico
        chartData.labels = historicalData.timestamps.map(ts => {
          const d = new Date(ts);
          return d.getHours().toString().padStart(2, '0') + ':' + 
                d.getMinutes().toString().padStart(2, '0');
        });
        
        chartData.datasets[0].data = historicalData.temperatures;
        chartData.datasets[1].data = historicalData.humidities;
        
        // Actualizar el gr√°fico
        window.sensorChart.update();
      }
      
      // Escuchar cambios en tiempo real desde Firebase
      sensorRef.on('value', (snapshot) => {
        const data = snapshot.val();
        
        // Ocultar cargando con animaci√≥n y mostrar contenido
        loadingElement.style.opacity = 0;
        setTimeout(() => {
          loadingElement.style.display = 'none';
          dashboardContent.style.display = 'block';
          
          // Inicializar valores min/max con el primer valor recibido
          if (minTemp === Infinity && maxTemp === -Infinity && data) {
            minTemp = data.temperature;
            maxTemp = data.temperature;
            minTempElement.textContent = minTemp.toFixed(1);
            maxTempElement.textContent = maxTemp.toFixed(1);
          }
          
          // Agregar animaci√≥n al mostrar el contenido
          setTimeout(() => {
            dashboardContent.style.opacity = 1;
          }, 100);
        }, 500);
        
        // Actualizar valores actuales
        if (data) {
          updateCurrentValues(data.temperature, data.humidity, data.status);
          updateChartData(Date.now());
        }
      }, (error) => {
        console.error("Error al leer datos:", error);
        loadingElement.style.opacity = 0;
        setTimeout(() => {
          loadingElement.style.display = 'none';
          errorMessage.style.display = 'block';
          updateConnectionStatus('offline');
        }, 500);
      });
      
      // Inicializar con datos simulados hasta recibir datos reales
      // Esto es solo para dar una idea visual al usuario antes de que lleguen datos reales
      for (let i = 0; i < 10; i++) {
        const timestamp = Date.now() - (9 - i) * 60000; // Cada minuto
        const tempValue = 25 + Math.random() * 5;
        const humidityValue = 50 + Math.random() * 10;
        
        historicalData.timestamps.push(timestamp);
        historicalData.temperatures.push(tempValue);
        historicalData.humidities.push(humidityValue);
      }
      
      // Actualizar gr√°fico con datos simulados
      chartData.labels = historicalData.timestamps.map(ts => {
        const d = new Date(ts);
        return d.getHours().toString().padStart(2, '0') + ':' + 
              d.getMinutes().toString().padStart(2, '0');
      });
      
      chartData.datasets[0].data = historicalData.temperatures;
      chartData.datasets[1].data = historicalData.humidities;
      
      window.sensorChart.update();
      
      // Funci√≥n para reiniciar/actualizar el gr√°fico
      function resetChart() {
        // A√±adir animaci√≥n al bot√≥n
        const refreshBtn = document.getElementById('refresh-chart');
        const refreshIcon = refreshBtn.querySelector('.refresh-icon');
        refreshIcon.classList.add('refresh-animation');
        
        // Limpiar datos hist√≥ricos
        historicalData = {
          timestamps: [],
          temperatures: [],
          humidities: []
        };
        
        // Generar nuevos datos de ejemplo (o se podr√≠a hacer una nueva consulta a Firebase)
        for (let i = 0; i < 10; i++) {
          const timestamp = Date.now() - (9 - i) * 60000; // Cada minuto
          const tempValue = parseFloat(document.getElementById('temp-value').textContent) + (Math.random() * 2 - 1);
          const humidityValue = parseFloat(document.getElementById('humidity-value').textContent) + (Math.random() * 4 - 2);
          
          historicalData.timestamps.push(timestamp);
          historicalData.temperatures.push(tempValue);
          historicalData.humidities.push(humidityValue);
        }
        
        // Actualizar datos del gr√°fico
        chartData.labels = historicalData.timestamps.map(ts => {
          const d = new Date(ts);
          return d.getHours().toString().padStart(2, '0') + ':' + 
                d.getMinutes().toString().padStart(2, '0');
        });
        
        chartData.datasets[0].data = historicalData.temperatures;
        chartData.datasets[1].data = historicalData.humidities;
        
        // Actualizar el gr√°fico con animaci√≥n
        window.sensorChart.update('active');
        
        // Quitar la animaci√≥n despu√©s de un tiempo
        setTimeout(() => {
          refreshIcon.classList.remove('refresh-animation');
        }, 1000);
      }
      
      // Agregar evento click al bot√≥n de actualizaci√≥n
      document.getElementById('refresh-chart').addEventListener('click', resetChart);
      
    } catch (error) {
      console.error("Error al inicializar Firebase:", error);
      loadingElement.style.opacity = 0;
      setTimeout(() => {
        loadingElement.style.display = 'none';
        errorMessage.style.display = 'block';
        updateConnectionStatus('offline');
      }, 500);
      errorMessage.textContent = "Error al conectar con Firebase: " + error.message;
    }
  </script>
</body>
</html>