<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Monitor de Temperatura y Humedad</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-database-compat.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      transition: all 0.5s ease;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #6a85b6 0%, #bac8e0 100%);
      color: #333;
      line-height: 1.6;
      min-height: 100vh;
      transition: background 1.5s ease;
    }
    
    /* Estilos para diferentes temperaturas */
    body.temp-cold {
      background: linear-gradient(135deg, #5b86e5 0%, #36d1dc 100%);
    }
    
    body.temp-cool {
      background: linear-gradient(135deg, #36d1dc 0%, #5b86e5 100%);
    }
    
    body.temp-mild {
      background: linear-gradient(135deg, #7bc6cc 0%, #be93c5 100%);
    }
    
    body.temp-warm {
      background: linear-gradient(135deg, #ffd89b 0%, #ff9d6c 100%);
    }
    
    body.temp-hot {
      background: linear-gradient(135deg, #ff9a9e 0%, #ff7966 100%);
    }
    
    body.temp-very-hot {
      background: linear-gradient(135deg, #ff7966 0%, #ff4b2b 100%);
    }
    
    .container {
      width: 95%;
      max-width: 1200px;
      margin: 15px auto;
      background-color: rgba(255, 255, 255, 0.92);
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
      padding: 20px;
      overflow: hidden;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    
    h1 {
      color: #333;
      text-align: center;
      margin-bottom: 20px;
      font-size: 1.8rem;
    }
    
    @media (max-width: 600px) {
      h1 {
        font-size: 1.5rem;
      }
    }
    
    .current-readings {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-around;
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .reading-card {
      background-color: rgba(248, 249, 250, 0.8);
      border-radius: 10px;
      padding: 20px;
      min-width: 150px;
      flex: 1;
      text-align: center;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      border: 1px solid rgba(0, 0, 0, 0.05);
    }
    
    .reading-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }
    
    .reading-card h2 {
      margin-top: 0;
      color: #555;
      font-size: 1.2rem;
    }
    
    .reading-value {
      font-size: 2.5rem;
      font-weight: bold;
      margin: 10px 0;
    }
    
    @media (max-width: 600px) {
      .reading-value {
        font-size: 2rem;
      }
    }
    
    .temperature {
      color: #dc3545;
    }
    
    .humidity {
      color: #0d6efd;
    }
    
    .temp-icon {
      font-size: 1.8rem;
      margin: 5px 0;
    }
    
    .chart-container {
      position: relative;
      height: 50vh;
      min-height: 300px;
      width: 100%;
      margin: 20px 0;
      background-color: rgba(255, 255, 255, 0.7);
      padding: 10px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    
    .footer {
      text-align: center;
      margin-top: 20px;
      color: #6c757d;
      font-size: 0.9rem;
      padding: 10px 0;
      border-top: 1px solid rgba(238, 238, 238, 0.7);
    }
    
    .last-update {
      text-align: right;
      font-size: 0.8rem;
      color: #6c757d;
      margin-top: 10px;
    }
    
    /* Estado de carga */
    .loading {
      text-align: center;
      padding: 30px;
      color: #6c757d;
    }
    
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border-left-color: #0d6efd;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .status-indicator {
      display: inline-block;
      font-size: 0.9rem;
      padding: 8px 15px;
      border-radius: 30px;
      margin: 15px auto;
      text-align: center;
      display: block;
      max-width: 150px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    
    .status-ok {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .status-warning {
      background-color: #fff3cd;
      color: #856404;
      border: 1px solid #ffeeba;
    }
    
    .status-error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    /* Dise√±o de orientaci√≥n */
    @media (orientation: landscape) and (max-height: 500px) {
      .container {
        padding: 10px;
      }
      
      .current-readings {
        margin-bottom: 15px;
      }
      
      .chart-container {
        height: 40vh;
        min-height: 200px;
      }
    }
    
    /* Estilo para mensajes de error */
    .error-message {
      background-color: #f8d7da;
      color: #721c24;
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
      text-align: center;
      display: none;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      border: 1px solid #f5c6cb;
    }
    
    /* Temperatura descriptor */
    .temp-descriptor {
      display: block;
      text-align: center;
      margin: 10px auto 20px;
      font-size: 1.2rem;
      padding: 10px 20px;
      border-radius: 30px;
      color: white;
      font-weight: bold;
      max-width: 250px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }
    
    .temp-cold-text {
      background: linear-gradient(to right, #5b86e5, #36d1dc);
    }
    
    .temp-mild-text {
      background: linear-gradient(to right, #7bc6cc, #be93c5);
    }
    
    .temp-warm-text {
      background: linear-gradient(to right, #ffd89b, #ff9a9e);
    }
    
    .temp-hot-text {
      background: linear-gradient(to right, #ff9a9e, #ff4b2b);
    }
  </style>
</head>
<body class="temp-mild">
  <div class="container">
    <h1>Monitor de Temperatura y Humedad</h1>
    
    <div id="error-message" class="error-message">
      Error al conectar con la base de datos. Por favor, verifica tu conexi√≥n.
    </div>
    
    <div id="loading" class="loading">
      <div class="spinner"></div>
      <p>Cargando datos...</p>
    </div>
    
    <div id="dashboard-content" style="display: none;">
      <div id="temp-descriptor" class="temp-descriptor temp-mild-text">Temperatura normal</div>
      
      <div class="current-readings">
        <div class="reading-card">
          <h2>Temperatura</h2>
          <div id="temp-icon" class="temp-icon">üå°Ô∏è</div>
          <div class="reading-value temperature" id="temp-value">--</div>
          <div>¬∞C</div>
        </div>
        
        <div class="reading-card">
          <h2>Humedad</h2>
          <div class="temp-icon">üíß</div>
          <div class="reading-value humidity" id="humidity-value">--</div>
          <div>%</div>
        </div>
      </div>
      
      <div id="status-indicator" class="status-indicator status-ok">Estado: OK</div>
      
      <div class="chart-container">
        <canvas id="sensorChart"></canvas>
      </div>
      
      <div class="last-update" id="last-update">√öltima actualizaci√≥n: --</div>
      
      <div class="footer">
        <p>ESP32 + Firebase + Sensor DHT</p>
      </div>
    </div>
  </div>

  <script>
    // Configuraci√≥n de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyA6L6vcWsQcaucQTjmz7svKrCo1t0L-M6c",
      authDomain: "esp32-93fbb.firebaseapp.com",
      databaseURL: "https://esp32-93fbb-default-rtdb.firebaseio.com",
      projectId: "esp32-93fbb",
      storageBucket: "esp32-93fbb.firebasestorage.app",
      messagingSenderId: "623403559263",
      appId: "1:623403559263:web:afdd3dca5dddf9d6346eea",
      measurementId: "G-XWZK0QF50D"
    };
    
    // Elementos del DOM
    const tempValue = document.getElementById('temp-value');
    const humidityValue = document.getElementById('humidity-value');
    const lastUpdate = document.getElementById('last-update');
    const statusIndicator = document.getElementById('status-indicator');
    const loadingElement = document.getElementById('loading');
    const dashboardContent = document.getElementById('dashboard-content');
    const errorMessage = document.getElementById('error-message');
    const tempDescriptor = document.getElementById('temp-descriptor');
    const tempIcon = document.getElementById('temp-icon');
    const bodyElement = document.body;
    
    // Variables para almacenar datos hist√≥ricos
    let historicalData = {
      timestamps: [],
      temperatures: [],
      humidities: []
    };
    
    // Funci√≥n para formatear la fecha
    function formatDate(date) {
      return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
    }
    
    // Funci√≥n para actualizar el indicador de estado
    function updateStatusIndicator(status) {
      statusIndicator.textContent = `Estado: ${status}`;
      statusIndicator.className = 'status-indicator';
      
      if (status === 'OK') {
        statusIndicator.classList.add('status-ok');
      } else if (status === 'WARNING') {
        statusIndicator.classList.add('status-warning');
      } else {
        statusIndicator.classList.add('status-error');
      }
    }
    
    // Funci√≥n para actualizar el estilo basado en la temperatura
    function updateTemperatureStyle(temperature) {
      // Remover todas las clases de temperatura
      bodyElement.classList.remove('temp-cold', 'temp-cool', 'temp-mild', 'temp-warm', 'temp-hot', 'temp-very-hot');
      tempDescriptor.classList.remove('temp-cold-text', 'temp-mild-text', 'temp-warm-text', 'temp-hot-text');
      
      // Determinar clase y descripci√≥n seg√∫n rango de temperatura
      let tempClass = '';
      let tempTextClass = '';
      let description = '';
      let iconEmoji = '';
      
      if (temperature <= 15) {
        tempClass = 'temp-cold';
        tempTextClass = 'temp-cold-text';
        description = 'Muy fr√≠o';
        iconEmoji = '‚ùÑÔ∏è';
      } else if (temperature <= 20) {
        tempClass = 'temp-cool';
        tempTextClass = 'temp-cold-text';
        description = 'Fr√≠o';
        iconEmoji = 'üßä';
      } else if (temperature <= 24) {
        tempClass = 'temp-mild';
        tempTextClass = 'temp-mild-text';
        description = 'Fresco';
        iconEmoji = 'üå§Ô∏è';
      } else if (temperature <= 28) {
        tempClass = 'temp-warm';
        tempTextClass = 'temp-mild-text';
        description = 'Templado';
        iconEmoji = '‚òÄÔ∏è';
      } else if (temperature <= 32) {
        tempClass = 'temp-hot';
        tempTextClass = 'temp-warm-text';
        description = 'Caluroso';
        iconEmoji = 'üî•';
      } else {
        tempClass = 'temp-very-hot';
        tempTextClass = 'temp-hot-text';
        description = 'Muy caluroso';
        iconEmoji = 'üî•üî•';
      }
      
      // Aplicar clases
      bodyElement.classList.add(tempClass);
      tempDescriptor.classList.add(tempTextClass);
      tempDescriptor.textContent = description;
      tempIcon.textContent = iconEmoji;
    }
    
    // Funci√≥n para actualizar los valores actuales
    function updateCurrentValues(temp, humidity, status) {
      tempValue.textContent = temp.toFixed(1);
      humidityValue.textContent = humidity.toFixed(1);
      updateStatusIndicator(status || 'OK');
      updateTemperatureStyle(temp);
      
      const date = new Date();
      lastUpdate.textContent = `√öltima actualizaci√≥n: ${formatDate(date)}`;
    }
    
    // Inicializar Firebase
    try {
      firebase.initializeApp(firebaseConfig);
      const database = firebase.database();
      const sensorRef = database.ref('sensor');
      
      // Datos para el gr√°fico
      const chartData = {
        labels: [],
        datasets: [
          {
            label: 'Temperatura (¬∞C)',
            data: [],
            borderColor: '#dc3545',
            backgroundColor: 'rgba(220, 53, 69, 0.1)',
            yAxisID: 'y',
            tension: 0.3,
            pointRadius: 3
          },
          {
            label: 'Humedad (%)',
            data: [],
            borderColor: '#0d6efd',
            backgroundColor: 'rgba(13, 110, 253, 0.1)',
            yAxisID: 'y1',
            tension: 0.3,
            pointRadius: 3
          }
        ]
      };
      
      // Configuraci√≥n del gr√°fico
      const chartConfig = {
        type: 'line',
        data: chartData,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false,
          },
          stacked: false,
          plugins: {
            legend: {
              position: 'top',
              labels: {
                boxWidth: 12,
                usePointStyle: true
              }
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.7)',
              padding: 10,
              cornerRadius: 5
            }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: 'Tiempo'
              },
              ticks: {
                maxRotation: 45,
                minRotation: 45,
                autoSkip: true,
                maxTicksLimit: 10
              }
            },
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              title: {
                display: true,
                text: 'Temperatura (¬∞C)'
              },
              min: 0,
              suggestedMax: 40,
              ticks: {
                stepSize: 5
              }
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              title: {
                display: true,
                text: 'Humedad (%)'
              },
              min: 0,
              max: 100,
              grid: {
                drawOnChartArea: false,
              },
              ticks: {
                stepSize: 10
              }
            },
          }
        },
      };
      
      // Crear el gr√°fico
      const ctx = document.getElementById('sensorChart').getContext('2d');
      const sensorChart = new Chart(ctx, chartConfig);
      
      // Funci√≥n para actualizar el gr√°fico con nuevos datos
      function updateChartData(timestamp) {
        const now = new Date();
        const timeStr = now.getHours().toString().padStart(2, '0') + ':' + 
                        now.getMinutes().toString().padStart(2, '0');
        
        // Guardar datos hist√≥ricos
        historicalData.timestamps.push(timestamp);
        historicalData.temperatures.push(parseFloat(tempValue.textContent));
        historicalData.humidities.push(parseFloat(humidityValue.textContent));
        
        // Limitamos a los √∫ltimos 20 puntos de datos para mejor visualizaci√≥n
        if (historicalData.timestamps.length > 20) {
          historicalData.timestamps.shift();
          historicalData.temperatures.shift();
          historicalData.humidities.shift();
        }
        
        // Actualizar datos del gr√°fico
        chartData.labels = historicalData.timestamps.map(ts => {
          const d = new Date(ts);
          return d.getHours().toString().padStart(2, '0') + ':' + 
                d.getMinutes().toString().padStart(2, '0');
        });
        
        chartData.datasets[0].data = historicalData.temperatures;
        chartData.datasets[1].data = historicalData.humidities;
        
        // Actualizar el gr√°fico
        sensorChart.update();
      }
      
      // Escuchar cambios en tiempo real desde Firebase
      sensorRef.on('value', (snapshot) => {
        const data = snapshot.val();
        
        // Ocultar cargando y mostrar contenido
        loadingElement.style.display = 'none';
        dashboardContent.style.display = 'block';
        
        // Actualizar valores actuales
        if (data) {
          updateCurrentValues(data.temperature, data.humidity, data.status);
          updateChartData(Date.now());
        }
      }, (error) => {
        console.error("Error al leer datos:", error);
        loadingElement.style.display = 'none';
        errorMessage.style.display = 'block';
      });
      
      // Inicializar con datos simulados hasta recibir datos reales
      // Esto es solo para dar una idea visual al usuario antes de que lleguen datos reales
      for (let i = 0; i < 10; i++) {
        const timestamp = Date.now() - (9 - i) * 60000; // Cada minuto
        const tempValue = 25 + Math.random() * 5;
        const humidityValue = 50 + Math.random() * 10;
        
        historicalData.timestamps.push(timestamp);
        historicalData.temperatures.push(tempValue);
        historicalData.humidities.push(humidityValue);
      }
      
      // Actualizar gr√°fico con datos simulados
      chartData.labels = historicalData.timestamps.map(ts => {
        const d = new Date(ts);
        return d.getHours().toString().padStart(2, '0') + ':' + 
              d.getMinutes().toString().padStart(2, '0');
      });
      
      chartData.datasets[0].data = historicalData.temperatures;
      chartData.datasets[1].data = historicalData.humidities;
      
      sensorChart.update();
      
      // Ajustar tama√±o del gr√°fico en caso de cambio de orientaci√≥n
      window.addEventListener('resize', () => {
        sensorChart.resize();
      });
      
    } catch (error) {
      console.error("Error al inicializar Firebase:", error);
      loadingElement.style.display = 'none';
      errorMessage.style.display = 'block';
      errorMessage.textContent = "Error al conectar con Firebase: " + error.message;
    }
  </script>
</body>
</html>